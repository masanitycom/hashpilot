# 本番環境 緊急修正 実行ガイド

## 🚨 重要事項

- **この作業は本番環境に影響します**
- **必ず順番通りに実行してください**
- **各ステップの結果を確認してから次に進んでください**
- **問題があればすぐに作業を停止してください**

---

## 📋 実行前チェックリスト

- [ ] 本番環境のSupabaseダッシュボードにアクセスできる
- [ ] SQL Editorが使用できる
- [ ] すべてのスクリプトファイルが準備できている
- [ ] 作業時間が確保できている（目安: 30-60分）
- [ ] ユーザーへの影響を最小限にするため、オフピーク時間である

---

## 🎯 修正内容の概要

### 問題点
1. **運用開始前のユーザーへの誤配布**: 38ユーザー、$81,000の投資が運用開始前なのに日利を受け取っていた
2. **91ユーザーのフラグ未更新**: NFTは存在するが `has_approved_nft = false` または `operation_start_date = NULL`
3. **V1システムの欠陥**: `process_daily_yield_with_cycles` 関数が運用開始日をチェックしていない

### 修正内容
1. **バックアップ作成**: すべてのデータをバックアップ
2. **誤配布確認**: 誤配布の詳細データを確認
3. **V1関数修正**: 運用開始日チェックを追加
4. **フラグ修正**: 91ユーザーのフラグを正しく設定
5. **データ削除**: 誤配布されたデータを削除・調整

---

## 📝 実行手順

### STEP 0: システム停止

**重要: 日利処理を一時停止してください**

1. 管理画面 `/admin/yield` にアクセスしない
2. 新しい日利を設定しない
3. すべてのステップが完了するまで日利処理を実行しない

---

### STEP 1: バックアップの作成 ⏱️ 5分

#### 1-1. Supabaseダッシュボードにアクセス

1. https://supabase.com にログイン
2. 本番環境のプロジェクト（HASH PILOT）を選択
3. 左メニューから「SQL Editor」をクリック

#### 1-2. バックアップスクリプトを実行

1. 新しいクエリを作成
2. `scripts/STEP1-CREATE-BACKUP.sql` の内容を全てコピー＆ペースト
3. 「Run」ボタンをクリック
4. 実行結果を確認

#### 1-3. 確認事項

以下がすべて表示されることを確認：
- ✅ バックアップスキーマ作成完了: backup_20251115
- ✅ usersテーブルのバックアップ完了
- ✅ nft_daily_profitテーブルのバックアップ完了
- ✅ user_referral_profitテーブルのバックアップ完了
- ✅ affiliate_cycleテーブルのバックアップ完了
- ✅ nft_masterテーブルのバックアップ完了
- ✅ purchasesテーブルのバックアップ完了

**レコード数の比較で「✅ 一致」がすべてのテーブルに表示されることを確認**

#### 1-4. 次のステップへ

すべて正常に完了したら、STEP 2に進んでください。

---

### STEP 2: 誤配布データの確認 ⏱️ 5分

#### 2-1. 確認スクリプトを実行

1. 新しいクエリを作成
2. `scripts/STEP2-CHECK-INCORRECT-DISTRIBUTION.sql` の内容を全てコピー＆ペースト
3. 「Run」ボタンをクリック
4. 実行結果を確認

#### 2-2. 確認事項

以下の情報を記録してください：
- **誤配布の合計金額**:
  - incorrect_personal_profit: $______
  - incorrect_referral_profit: $______
  - total_incorrect_profit: $______
- **削除対象のレコード数**:
  - nft_daily_profit_records: ______件
  - user_referral_profit_records: ______件
  - affected_users: ______人

#### 2-3. 次のステップへ

結果を確認したら、STEP 3に進んでください。

---

### STEP 3: V1関数の修正 ⏱️ 2分

#### 3-1. 関数修正スクリプトを実行

1. 新しいクエリを作成
2. `scripts/STEP3-FIX-V1-FUNCTION.sql` の内容を全てコピー＆ペースト
3. 「Run」ボタンをクリック
4. 実行結果を確認

#### 3-2. 確認事項

以下のメッセージが表示されることを確認：
- ✅✅✅ process_daily_yield_with_cycles 関数の修正が完了しました ✅✅✅

#### 3-3. 修正内容

以下の3つの修正が適用されました：
1. STEP 2（個人利益配布）: operation_start_date のチェック追加
2. STEP 3（紹介報酬配布）: 紹介される側と紹介者の両方をチェック
3. STEP 4（NFT自動付与）: operation_start_date のチェック追加

#### 3-4. 次のステップへ

修正が完了したら、STEP 4に進んでください。

---

### STEP 4: ユーザーフラグの修正 ⏱️ 5-10分

#### 4-1. フラグ修正スクリプトを開く

1. 新しいクエリを作成
2. `scripts/STEP4-FIX-USER-FLAGS.sql` の内容を全てコピー＆ペースト
3. まず、STEP 4-1の確認クエリのみを実行

#### 4-2. 修正前の確認

以下の情報を記録してください：
- has_approved_nft修正対象: ______ユーザー、$______投資
- operation_start_date修正対象: ______ユーザー、$______投資

#### 4-3. has_approved_nft の更新

1. STEP 4-2のコメント `/* ... */` を外す
2. `BEGIN;` から `COMMIT;` までを選択して実行
3. 結果を確認
4. 問題なければ `COMMIT;` を実行（問題があれば `ROLLBACK;`）

確認事項：
- ✅ has_approved_nft更新完了
- remaining_issues: 0

#### 4-4. operation_start_date の更新

1. STEP 4-3のコメント `/* ... */` を外す
2. `BEGIN;` から `COMMIT;` までを選択して実行
3. 結果を確認
4. 問題なければ `COMMIT;` を実行（問題があれば `ROLLBACK;`）

確認事項：
- ✅ operation_start_date更新完了
- remaining_issues: 0

#### 4-5. 更新後の確認

STEP 4-4の確認クエリを実行して、以下を確認：
- ✅ 修正後の確認: has_approved_nft → 「✅ 問題なし」
- ✅ 修正後の確認: operation_start_date → 「✅ 問題なし」

#### 4-6. 次のステップへ

すべて正常に完了したら、STEP 5に進んでください。

---

### STEP 5: 誤配布データの削除 ⏱️ 5-10分

⚠️⚠️⚠️ **この操作は取り消せません** ⚠️⚠️⚠️

#### 5-1. 削除スクリプトを開く

1. 新しいクエリを作成
2. `scripts/STEP5-DELETE-INCORRECT-DATA.sql` の内容を全てコピー＆ペースト
3. まず、STEP 5-1とSTEP 5-2の確認クエリのみを実行

#### 5-2. 削除前の最終確認

以下の情報を再度確認してください：
- 削除対象: nft_daily_profit → ______件、$______
- 削除対象: user_referral_profit → ______件、$______

#### 5-3. affiliate_cycleの調整額を確認

各ユーザーの調整額を確認してください：
- personal_to_deduct: 個人利益から差し引く金額
- referral_to_deduct: 紹介報酬から差し引く金額
- new_cum_usdt: 調整後のcum_usdt
- new_available_usdt: 調整後のavailable_usdt

**⚠️ マイナスになるユーザーがいないか確認してください**

#### 5-4. 削除とaffiliate_cycleの調整を実行

⚠️⚠️⚠️ **最後の確認** ⚠️⚠️⚠️

- [ ] バックアップが作成されている
- [ ] 削除対象を確認した
- [ ] 調整額を確認した
- [ ] マイナス残高になるユーザーがいないことを確認した

確認が完了したら：

1. STEP 5-3のコメント `/* ... */` を外す
2. `BEGIN;` から `ROLLBACK;` までを選択して実行
3. すべての結果を確認
4. **問題なければ** `COMMIT;` に変更して実行
5. **問題があれば** そのまま `ROLLBACK;` を実行

#### 5-5. 削除完了の確認

以下のメッセージが表示されることを確認：
- ✅ affiliate_cycle（個人利益分）調整完了
- ✅ affiliate_cycle（紹介報酬分）調整完了
- ✅ nft_daily_profit削除完了
- ✅ user_referral_profit削除完了
- ✅ すべて削除されました

#### 5-6. 最終確認

STEP 5-4の確認クエリを実行して、以下を確認：
- ✅✅✅ すべての誤配布データが削除されました ✅✅✅
- 運用中のユーザー: ______人、$______投資
- affiliate_cycle整合性確認: 「✅ 問題なし」

---

### STEP 6: システム再開 ⏱️ 5分

#### 6-1. 動作確認

1. 管理画面 `/admin/yield` にアクセス
2. 総投資額が正しく表示されているか確認
3. ユーザーダッシュボードで数値が正しいか確認

#### 6-2. テスト日利の設定（オプション）

1. 過去の日付で小額の日利を設定してテスト
2. 運用開始前のユーザーに配布されていないことを確認
3. 運用中のユーザーのみに配布されていることを確認

#### 6-3. 日利処理の再開

すべて正常に動作していることを確認したら、通常の日利処理を再開してください。

---

## 🆘 トラブルシューティング

### バックアップの作成に失敗する

**症状**: STEP 1でエラーが発生する

**対処法**:
1. Supabaseの接続を確認
2. 権限を確認
3. ブラウザのコンソールでエラーを確認
4. 必要に応じてSupabaseサポートに連絡

### 削除後にマイナス残高が発生した

**症状**: affiliate_cycleでマイナス値が発生

**対処法**:
1. すぐに `ROLLBACK;` を実行
2. バックアップから復元（`scripts/RESTORE-FROM-BACKUP.sql`）
3. 原因を調査
4. 個別に修正が必要

### 削除したデータを復元したい

**対処法**:
1. `scripts/RESTORE-FROM-BACKUP.sql` を開く
2. 復元したいテーブルのコメントを外す
3. `BEGIN;` から実行して結果を確認
4. 問題なければ `COMMIT;` を実行

---

## 📊 作業完了後の確認項目

- [ ] バックアップが作成されている
- [ ] V1関数が修正されている
- [ ] 91ユーザーのフラグが修正されている
- [ ] 誤配布データが削除されている
- [ ] affiliate_cycleが正しく調整されている
- [ ] マイナス残高のユーザーがいない
- [ ] 運用中のユーザー数が正しい
- [ ] 総投資額が正しい
- [ ] システムが正常に動作している

---

## 📝 作業記録

### 作業日時
- 開始: 2025年11月15日 __:__ JST
- 完了: 2025年11月15日 __:__ JST

### 作業結果

**STEP 1: バックアップ**
- バックアップスキーマ: backup_20251115
- テーブル数: 6
- 総レコード数: ______

**STEP 2: 誤配布確認**
- 誤配布の合計金額: $______
- 削除対象レコード数: ______件

**STEP 3: V1関数修正**
- 修正完了: ✅

**STEP 4: フラグ修正**
- has_approved_nft修正: ______ユーザー
- operation_start_date修正: ______ユーザー

**STEP 5: データ削除**
- nft_daily_profit削除: ______件
- user_referral_profit削除: ______件
- affiliate_cycle調整: ______ユーザー

**STEP 6: システム再開**
- 動作確認: ✅
- 日利処理再開: ✅

---

## 📞 サポート

問題が発生した場合は、以下の情報と共に報告してください：
1. エラーメッセージ（スクリーンショット）
2. どのステップで問題が発生したか
3. 実行したSQL文
4. バックアップの状態

---

最終更新: 2025年11月15日
