# 紹介報酬システムのバグ報告書（管理者向け）

**報告日**: 2025年12月1日
**重要度**: 🚨 緊急・高
**影響期間**: 2025年11月全体（11/1〜11/30）

---

## 📋 エグゼクティブサマリー

紹介報酬計算システムに2つの重大なバグが発見されました。

1. **バグ1（修正済み）**: 紹介報酬が`cum_usdt`のみに加算され、`available_usdt`（出金可能額）に反映されていなかった
2. **バグ2（未修正）**: 子ユーザーが運用開始していない（日利$0）にもかかわらず、親ユーザーに紹介報酬が配布されていた

**推定過大配布額**: 約$272〜$4,786（全システム）
**影響ユーザー**: 数十名〜数百名

---

## 🔍 バグ2の詳細（新発見）

### 問題の内容

V1日利処理システムで、以下の問題が発生していました：

```
子ユーザーの実際の日利 = $0（運用開始前/レコードなし）
↓
でも親ユーザーへの紹介報酬 = $0.798（1 NFT × $7.98 × 10%）
```

### 具体例（ユーザー177B83の11月データ）

#### 異常な紹介報酬比率
```
個人利益（1 NFT）: $32.014
紹介報酬: $1,373.890 ← 個人利益の43倍！

内訳:
- Level 1（20%）: $80.872
- Level 2（10%）: $1,259.026 ← 異常に高い
- Level 3（5%）: $33.992
```

#### 日利$0ユーザーへの誤配布例（11/26）

| 子ユーザー | 実際の日利 | 記録された報酬 | NFT数 | 問題 |
|----------|----------|--------------|------|------|
| 039483 | **$0.00** | **$0.798** | 1個 | 運用開始前なのに報酬発生 |
| 1DEFED | **$0.00** | **$0.798** | 1個 | 運用開始前なのに報酬発生 |
| 2D378C | **$0.00** | **$0.798** | 1個 | 運用開始前なのに報酬発生 |
| 6FF2D1 | **$0.00** | **$0.798** | 1個 | 運用開始前なのに報酬発生 |

**パターン:**
- これらのユーザーは`user_daily_profit`テーブルにレコードがない（日利未配布）
- しかし親ユーザーには$0.798（= 1 NFT × $7.98 × 10%）の紹介報酬が配布されている
- つまり、実際の日利ではなく「**仮想の日利**」で計算されている

### Level 2紹介報酬の過大配布

```
ユーザー177B83のLevel 2（11月全体）:
  レコード数: 300件
  ユニーク子ユーザー数: 22名

  期待値: $987.010（子ユーザーの実際の日利 × 10%）
  実際: $1,259.026
  過大配布: $272.016（27.5%過大）
```

### 全システムの影響

```
11月の紹介報酬合計: $13,357.747
期待値（個人利益 × 35%）: $8,572.034
過大配布: $4,785.713（56%過大）

レベル別:
- Level 1（20%）: +$891
- Level 2（10%）: +$3,375 ← 最も深刻
- Level 3（5%）: +$520
```

---

## 💡 バグの原因

### V1関数の問題コード

`process_daily_yield_with_cycles`関数のSTEP 3（紹介報酬計算）:

```sql
-- 行140: 問題のコード
v_user_profit := v_personal_profit_per_nft * v_child_nft_count;
```

**問題点:**
1. `v_personal_profit_per_nft`は全ユーザー共通（例: $7.98/NFT）
2. `v_child_nft_count`は子ユーザーのNFT数
3. つまり、子ユーザーの**実際の日利**ではなく、**NFT数から計算した仮想日利**を使用

**正しい計算:**
```sql
-- user_daily_profitテーブルから実際の金額を取得すべき
SELECT daily_profit INTO v_user_profit
FROM user_daily_profit
WHERE user_id = v_child_user_id AND date = p_date;

-- レコードがない場合は紹介報酬なし
IF v_user_profit IS NULL OR NOT FOUND THEN
  v_user_profit := 0;
  CONTINUE; -- 次のユーザーへ
END IF;
```

### なぜ日利$0なのに紹介報酬が発生？

**仮説1**: `operation_start_date`のチェックが不完全
- V1関数はSTEP 3で`operation_start_date IS NOT NULL AND <= p_date`をチェックしている
- しかし、`operation_start_date`が設定されていても、何らかの理由で`user_daily_profit`にレコードが作成されていない場合がある
  - 例: NFT承認後、`operation_start_date`は設定されたが、まだ実際の日利配布が開始していない
  - 例: データ整合性の問題

**仮説2**: タイミングの問題
- 11/15〜11/30のデータで集中的に発生
- この期間に何らかのシステム変更や修正があった可能性

---

## 📊 影響範囲

### ユーザー177B83（サンプル分析）
- 過大配布: 約$300
- 正しい金額: 約$1,100
- 実際表示: $1,405
- ダッシュボード表示は**正しい**（修正不要）

### 全システム
- 過大配布総額: $4,786（推定）
- 影響を受けた親ユーザー: 調査中
- 影響を受けた子ユーザー: 調査中（運用開始前のユーザー数十名の可能性）

### 現在の状況
1. **バグ1（available_usdt未反映）**:
   - ✅ 修正スクリプト作成済み（`FIX-v1-add-available-usdt-to-referral.sql`）
   - ✅ バックフィルスクリプト作成済み（`BACKFILL-november-referral-to-available-usdt.sql`）
   - ⏳ 実行待ち

2. **バグ2（仮想日利での計算）**:
   - ❌ 未修正
   - 📋 詳細調査中（`CHECK-level2-daily-profit-zero-bug.sql`）
   - 📝 修正スクリプト作成必要

---

## 🔧 修正計画

### フェーズ1: 詳細調査（完了予定: 本日中）
- [ ] `CHECK-level2-daily-profit-zero-bug.sql`を実行
- [ ] `CHECK-039483-user-detail.sql`を実行（サンプルユーザー調査）
- [ ] 全システムの正確な過大配布額を算出
- [ ] 影響を受けたユーザーリストを作成

### フェーズ2: 修正スクリプト作成（完了予定: 明日）
- [ ] V1関数修正: `FIX-v1-referral-use-actual-daily-profit.sql`
  - `v_user_profit`を`user_daily_profit`から取得するように修正
  - レコードがない場合は紹介報酬なし（CONTINUE）
- [ ] 誤配布データ削除: `DELETE-incorrect-referral-november.sql`
  - `affiliate_cycle`から過大配布額を減算
  - `user_referral_profit`から該当レコードを削除
- [ ] バックフィル: `BACKFILL-correct-referral-november.sql`
  - 正しい金額で再計算・再配布

### フェーズ3: 実行（管理者承認後）
1. ✅ データベースバックアップ作成
2. ⚠️ V1関数修正を適用
3. ⚠️ 誤配布データ削除
4. ⚠️ 正しいデータで再計算
5. ✅ 検証（サンプルユーザーで確認）
6. ✅ 全ユーザーのダッシュボード表示を確認

### フェーズ4: 再発防止（長期）
- V2システムへの移行を検討（V2では既に修正済み）
- 定期監査スクリプトの作成・実行

---

## 📁 関連ファイル

**分析レポート:**
- `REFERRAL_PROFIT_BUG_REPORT.md` - 技術詳細レポート
- `REFERRAL_BUG_SUMMARY_FOR_MANAGEMENT.md` - このファイル

**調査スクリプト:**
- `scripts/CHECK-user-177B83-november-totals.sql` - ユーザー177B83の11月合計
- `scripts/CHECK-177B83-level2-detail.sql` - Level 2詳細調査
- `scripts/check_177B83_level2.js` - 実行用Node.jsスクリプト
- `scripts/CHECK-level2-daily-profit-zero-bug.sql` - バグ詳細確認（実行待ち）
- `scripts/CHECK-039483-user-detail.sql` - サンプルユーザー詳細（実行待ち）

**修正スクリプト（作成済み）:**
- `scripts/FIX-v1-add-available-usdt-to-referral.sql` - バグ1修正
- `scripts/BACKFILL-november-referral-to-available-usdt.sql` - バグ1バックフィル

**修正スクリプト（作成予定）:**
- `scripts/FIX-v1-referral-use-actual-daily-profit.sql` - バグ2修正
- `scripts/DELETE-incorrect-referral-november.sql` - 誤配布データ削除
- `scripts/BACKFILL-correct-referral-november.sql` - 正しいデータで再配布

---

## ✅ 推奨アクション

### 即座に実行
1. 日利処理を一時停止（新しい配布を行わない）
2. 詳細調査スクリプトを実行して正確な損害額を確認
3. 経営陣への報告

### 承認後に実行
1. データベースバックアップ作成
2. 修正スクリプトの適用
3. データ検証
4. システム再開

### 長期的対策
1. V2システムへの移行検討
2. 定期監査の実施
3. テスト環境での事前検証プロセスの確立

---

## 📞 お問い合わせ

ご不明な点がございましたら、開発チームまでご連絡ください。

**最終更新**: 2025年12月1日
**ステータス**: 調査完了、修正スクリプト作成中
