# HASHPILOT システム管理ガイド

## 🚀 システム運用開始手順

### メインシステム運用開始時の設定変更

1. **環境変数の更新**
   ```bash
   # .env.local ファイルを編集
   NEXT_PUBLIC_SYSTEM_PREPARING=false  # true から false に変更
   ```

2. **デプロイ**
   ```bash
   npm run build
   # デプロイコマンド（環境に応じて）
   ```

3. **確認事項**
   - ダッシュボードの運用ステータスが「システム準備中」から「運用中」に変わることを確認
   - 15日ルールは自動計算されるため、追加の設定は不要

---

## 📊 Level 4+紹介者計算の仕様

### 現在の正確な数値
- **Level 4+紹介者数: 89人**（2025年1月時点）
- 160人と表示されていた理由: 以前は`total_purchases = 0`のユーザーも含めて計算していた

### 計算ロジック
```javascript
// app/dashboard/page.tsx
1. usersテーブルから total_purchases > 0 のユーザーのみ取得
2. referrer_user_id でレベル別に分類
3. Level 4+を最大500レベルまで計算（実際の深度は18レベル）
4. allProcessedIds で重複チェック済み
```

### 重要な仕様
- **人数カウント**: 各ユーザーは1回だけカウント（user_idの重複チェック済み）
- **金額反映**: `Math.floor(total_purchases / 1100) * 1000` で計算
- **複数NFT購入**: 人数は増えず、金額のみ増加

### 検証済み事項
✅ 新規登録ユーザーは total_purchases = 0 なので影響なし  
✅ NFT購入申請の重複があっても正しく処理  
✅ 管理者承認済みのユーザーのみカウント  
✅ 4つの異なる計算方法で全て89人に一致することを確認

---

## 🎯 運用ステータス表示の仕様

### 表示パターン

1. **システム準備中**（NEXT_PUBLIC_SYSTEM_PREPARING=true）
   - バッジ: 🔵 システム準備中
   - 説明文: 「※ 現在メインシステムの準備を進めています。15日ルールは適用されますが、実際の運用開始はシステム準備完了後となります。」
   
2. **運用待機中**（15日未経過）
   - バッジ: 🟠 運用待機中
   - 残り日数表示: (あとX日)

3. **運用中**（15日経過済み & NEXT_PUBLIC_SYSTEM_PREPARING=false）
   - バッジ: 🟢 運用中
   - 運用開始日表示

### 15日ルール
- **承認日から15日後に自動的に運用開始日を計算**
- システム準備中でも15日ルールのカウントは進行
- 実際の運用はシステム準備完了後

---

## 🔧 トラブルシューティング

### Level 4+の人数が想定と異なる場合
```bash
# 検証スクリプトを実行
node comprehensive_referral_verification.js
```

### 運用ステータスが正しく表示されない場合
1. `.env.local` の `NEXT_PUBLIC_SYSTEM_PREPARING` を確認
2. ブラウザのキャッシュをクリア
3. `npm run dev` で再起動

---

## 📝 重要な注意事項

1. **total_purchases の管理**
   - 管理者が手動で更新する必要がある
   - 購入承認時に必ず更新すること
   - 複数回の購入承認がある場合は合計額で更新

2. **データベースフィールド**
   - `users.nft_receive_address`（`nft_address`ではない）
   - `users.total_purchases` > 0 が投資済みユーザーの条件

3. **紹介レベルの制限**
   - 最大500レベルまで計算（実際は18レベル程度）
   - 無限ループ防止のための安全装置

---

## 📈 システム統計（2025年1月時点）

- 全ユーザー数: 189人
- 投資済みユーザー: 110人
- 複数NFT購入者: 7人
- 最大NFT購入数: 21個（$23,100）
- 紹介ツリー最大深度: 18レベル

---

## 💰 日利管理のマージン計算仕様（2025年8月24日更新）

### 基本ルール
- **プラス利益時**: マージン30%を引く（会社が取る）
- **マイナス利益時**: マージン30%を戻す（会社が補填する）

### 計算式
#### プラス利益時（日利率 > 0）
```
ユーザー受取率 = 日利率 × (1 - 0.30) × 0.6
例: +1.6% → 1.6% × 0.7 × 0.6 = 0.672%
```

#### マイナス利益時（日利率 < 0）
```
ユーザー受取率 = 日利率 × (1 + 0.30) × 0.6
例: -0.2% → -0.2% × 1.3 × 0.6 = -0.156%
```

### なぜこの計算方式？
月間累計で正しいマージン30%になるようにするため：
```
例：+$500, +$500, +$500, -$500 の場合
- 日次マージン: $150 + $150 + $150 - $150 = $300
- 月間累計利益: $1,000
- マージン率: $300 ÷ $1,000 = 30% ✅
```

### 重要な変更履歴
- 2025/08/24: マイナス時のマージン計算を修正（0% → 30%補填）
- 月末調整処理は不要（日次処理で自動的に正しくなる）

---

## 🔄 NFTサイクルシステム（2025年10月7日更新）

### 基本仕様
- **サイクル計算対象**: 紹介報酬のみ（個人利益は含めない）
- **NFT自動付与**: 紹介報酬が2200ドル到達時に自動的にNFTが付与される
- **フェーズ管理**:
  - **USDTフェーズ**: 紹介報酬 < 1100ドル（即時受取可能）
  - **HOLDフェーズ**: 紹介報酬 >= 1100ドル（次のNFT付与待ち、出金不可）
  - **NFT付与**: 紹介報酬 >= 2200ドル（自動NFT付与 + 1100ドル受取可能）

### 重要な注意事項
1. **個人利益（日利）はサイクルに含まれない**
   - 個人利益は`available_usdt`に直接加算される
   - サイクル計算は紹介報酬のみで行われる

2. **二重払い防止**
   - HOLDフェーズ中（cum_usdt >= 1100）の金額は出金不可
   - 次のNFT購入に使用される予定のため

3. **自動NFT付与の動作**
   - `cum_usdt >= 2200`到達時に`process_daily_yield_with_cycles`関数で自動処理
   - `nft_master`テーブルに実際のNFTレコードが作成される
   - `purchases`テーブルに`is_auto_purchase = true`のレコードが作成される

### データベーステーブル
- `affiliate_cycle.cum_usdt`: 紹介報酬の累積額
- `affiliate_cycle.available_usdt`: 即時受取可能な金額（個人利益 + NFT付与時の1100ドル）
- `affiliate_cycle.phase`: 現在のフェーズ（USDT/HOLD）
- `affiliate_cycle.auto_nft_count`: 自動付与されたNFT数
- `affiliate_cycle.manual_nft_count`: 手動購入したNFT数

---

## 🛠 開発環境

- Next.js 14 + TypeScript
- Supabase（データベース）
- Tailwind CSS（スタイリング）
- 段階的読み込み最適化（4ステージ）

---

## 📞 サポート

問題が発生した場合は、以下の情報と共に報告してください：
1. エラーメッセージ
2. 発生した操作
3. ユーザーID
4. ブラウザ情報

---

最終更新: 2025年10月7日