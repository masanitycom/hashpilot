# HashPilot NFT アフィリエイト報酬システム 実装メモ

## 最終更新: 2025-07-10

## 1. 日利計算の基本ロジック（修正版）

### 1.1 正しい日利計算式
```
1. 日利から会社マージン(30%)を差し引く
   マージン後利率 = 日利率 × (1 - 30%)

2. マージン後利率を以下の比率で配分
   - ユーザー受取: 60%
   - アフィリエイト: 30%
   - プール金: 10%

3. ユーザー表示利率 = マージン後利率 × 0.6
```

**計算例:**
- 日利率: +1.0%の場合
  - マージン後: 1.0% × (1 - 30%) = 0.7%
  - ユーザー受取: 0.7% × 0.6 = 0.42%
  
- 日利率: +1.8%の場合
  - マージン後: 1.8% × (1 - 30%) = 1.26%
  - ユーザー受取: 1.26% × 0.6 = 0.756%

- 日利率: +2.5%の場合
  - マージン後: 2.5% × (1 - 30%) = 1.75%
  - ユーザー受取: 1.75% × 0.6 = 1.05%

### 1.2 実際の金額計算
```
ユーザー日利 = NFT保有数 × 1000 USDT × ユーザー表示利率
```

## 2. 紹介報酬システム

### 2.1 報酬率
| レベル | 報酬率 | 対象 |
|--------|--------|------|
| L1 (直接紹介) | 25% | 紹介したユーザーの日利に対して |
| L2 (2段階目) | 10% | 紹介したユーザーの日利に対して |
| L3 (3段階目) | 5% | 紹介したユーザーの日利に対して |

### 2.2 紹介報酬計算式（修正版）
```
アフィリエイト総額 = 実効利率 × 0.3
この30%を以下の比率で配分：
- L1紹介報酬: アフィリエイト総額 × 25/30 = 実効利率 × 0.25
- L2紹介報酬: アフィリエイト総額 × 10/30 = 実効利率 × 0.10  
- L3紹介報酬: アフィリエイト総額 × 5/30 = 実効利率 × 0.05

実効利率 = (日利率 - 30%) × NFT保有数 × 1000 USDT
```

## 3. NFTサイクルシステム

### 3.1 サイクル状態
| 状態 | 累積額範囲 | 動作 |
|------|------------|------|
| USDT | 0 ≤ cum_usdt < 1100 | 即時受取可能 |
| HOLD | 1100 ≤ cum_usdt < 2200 | 受取保留 |
| リセット | cum_usdt ≥ 2200 | NFT自動購入 + リセット |

### 3.2 2200 USDT到達時の処理
1. NFT 1枚自動購入 (1100 USDT消費)
2. 残り1100 USDTを即時ユーザー残高に加算
3. cum_usdt = 0 にリセット
4. cycle_state = 'USDT' に戻す
5. cycle_count += 1

### 3.3 HOLD中の報酬処理
- 自己日利 → cum_usdtに加算のみ（受取なし）
- 紹介報酬 → cum_usdtに加算のみ（受取なし）
- pending_usdtは更新されない

## 4. 月次クローズ処理

### 4.1 処理内容
- **HOLD分は月末処理対象外**: cum_usdtは持ち越し
- **pending_usdtのみ確定**: 実際に受け取れる金額のみ処理
- **NFTサイクルは継続**: cycle_stateとcum_usdtは維持

## 5. NFTタイプの区別

| タイプ | 説明 | nft_holdings.type | 表示 |
|--------|------|-------------------|------|
| 手動購入NFT | ユーザーがUSDTで直接購入 | 'manual_purchase' | 🛒 手動購入 |
| 自動購入NFT | サイクル2200到達時に自動購入 | 'auto_buy' | 🔄 自動購入 |

## 6. 重要なフィールド定義

| フィールド | 用途 | リセット条件 |
|------------|------|--------------|
| cum_usdt | NFT自動購入判定用累積額 | NFT購入処理直後に0 |
| pending_usdt | USDT-フェーズで「まだ月末出金されていない」金額 | 月末クローズで0 |
| cycle_state | 'USDT' or 'HOLD' | NFT購入後に'USDT'へ |

## 7. 実装状況 (2025-07-10現在)

### 完了済み
- ✅ 管理画面の日利入力フォーム (app/admin/yield/page.tsx)
- ✅ データベーステーブル作成 (phase2-daily-yield-system.sql)
- ✅ 日利投稿関数 (admin_post_yield) - 手動実行型
- ✅ ユーザーダッシュボードの日利チャート表示 (components/daily-profit-chart.tsx)
- ✅ 月次報酬集計関数 (calculate_monthly_rewards) - enhance-yield-system-complete.sql
- ✅ user_monthly_rewardsテーブル - 月次報酬サマリー保存用

### 未実装
- ❌ サイクル処理ロジック（cum_usdt更新、2200到達時の自動NFT購入、USDT/HOLD切替）
- ❌ 自動化された日次バッチ処理（現在は手動実行のみ）
- ❌ Edge FunctionやCronによる自動実行
- ❌ affiliate_cycleテーブルの更新処理
- ❌ pending_usdtフィールド（available_usdtは存在するが未使用）
- ❌ ユーザーダッシュボードでのサイクル情報表示
- ❌ 出金キュー（payout_queue）処理

## 8. 重要な仕様書

1. **アフィリエイト報酬システム仕様書**: docs/affiliate-reward-system-spec.md
2. **報酬計算詳細仕様書**: docs/reward-calculation-spec.md

## 9. テスト時の注意事項

- 管理画面にはテストモードがあり、実際にデータベースに保存せずに計算結果のみ確認可能
- 本番モードでは即座にユーザー残高に反映されるため注意が必要
- 紹介報酬は3段階まで自動計算される

## 10. 次のステップ（優先度順）

1. **サイクル処理ロジックの実装**
   - cum_usdtを日利・紹介報酬で更新する処理
   - 2200 USDT到達時の自動NFT購入とリセット処理
   - USDT/HOLDフェーズ切り替えロジック

2. **ユーザーダッシュボードの拡張**
   - affiliate_cycle情報（現在のフェーズ、累積額、進捗バー）の表示
   - 自動購入NFTと手動購入NFTの区別表示

3. **日次バッチ処理の自動化**
   - Supabase Edge Functionの実装
   - Cronスケジューラーの設定

4. **出金システムの実装**
   - payout_queueテーブルとの連携
   - 管理画面での出金管理機能

## 11. 現在の課題

1. **affiliate_cycleテーブルが活用されていない**
   - テーブルは存在するが、更新処理が未実装
   - cum_usdt、available_usdt、phaseフィールドが機能していない

2. **日次処理が手動実行のみ**
   - 管理者が毎日手動で実行する必要がある
   - 自動化されていないため、運用負荷が高い

3. **サイクルシステムが未実装**
   - 仕様書には記載されているが、実装されていない
   - NFT自動購入機能が動作しない