# 日利システム調査レポート
**調査日時**: 2025年7月16日  
**調査者**: Claude  
**目的**: 現在日利が発生しているユーザーの確認と問題の特定

## 📊 調査結果概要

### システム統計
- **総ユーザー数**: 102人（全員アクティブ）
- **総投資額**: $123,200.00
- **総NFT**: 111個
- **アクティブサイクル**: 68個
- **システム状態**: 正常（データベース接続、ログ機能すべて正常）

### 日利配布状況
- **現在の日利受取者**: **0人**
- **過去7日間の日利受取者**: **0人**
- **配布総額**: **$0.00**

## 🔍 詳細調査結果

### 1. 日利設定の確認
最新の日利設定（過去5日間）:
```
2025-07-16: 日利1.5%, マージン3000.0%, ユーザー0.6%
2025-07-15: 日利1.5%, マージン3000.0%, ユーザー0.6%
2025-07-14: 日利0.4%, マージン30.0%, ユーザー0.2%
2025-07-13: 日利0.7%, マージン30.0%, ユーザー0.4%
2025-07-12: 日利0.2%, マージン30.0%, ユーザー0.1%
```

### 2. 日利配布履歴
過去7日間の配布実績:
```
2025-07-16: 0人に$0配布
2025-07-15: 0人に$0配布
2025-07-14: 0人に$0配布
2025-07-13: 0人に$0配布
2025-07-12: 0人に$0配布
2025-07-11: 0人に$0配布
2025-07-10: 0人に$0配布
```

### 3. システムヘルスチェック結果
```
- database: データベース接続正常
- users: 総ユーザー数: 102 / アクティブ: 102
- investments: 総投資額: $123,200.00
- logging: 24時間以内: 12ログ / 0エラー
- nft_cycles: NFTサイクル処理正常
```

## 🚨 発見された問題

### 1. 重大な設定問題
**マージン率が3000%という異常値**
- 通常は30%（0.30）であるべき
- 3000%（30.00）により、ユーザー受取率が異常に低下
- 計算式: ユーザー受取率 = 日利率 × (1 - マージン率/100)
- 現在: 1.5% × (1 - 3000%/100) = 負の値 → 0.6%に調整

### 2. 管理者権限の制限
- `admin_post_yield`関数の実行に管理者権限が必要
- 匿名ユーザーでの関数実行が制限される
- エラーメッセージ: "Admin access required"

### 3. RLS（Row Level Security）の制限
- 直接テーブルへのアクセスが制限
- `user_daily_profit`テーブルは0件として表示
- 実際のデータ存在の可能性はあるが、アクセス権限で確認不可

### 4. 日利処理の実行状況
- 日利設定は存在するが、実際の配布が0人
- 日利処理関数の実行エラーまたは条件不一致の可能性

## 💡 日利が発生していない可能性のある理由

### 1. 技術的な問題
1. **マージン率の異常値（3000%）**
   - ユーザー受取率の計算に影響
   - 負の値になる可能性

2. **NFT承認と運用開始条件**
   - NFT購入から15日経過の条件
   - `has_approved_nft`フラグの確認

3. **RLS（Row Level Security）の制限**
   - データベースアクセス制限
   - 実際のデータが見えない

4. **関数の実行権限**
   - 管理者権限なしでの関数実行制限
   - 自動バッチ処理の権限問題

### 2. データの整合性問題
1. **ユーザーデータの不整合**
   - `users`テーブルと`purchases`テーブルの関連
   - `user_id`の形式やマッピング

2. **購入データの承認状況**
   - `admin_approved`フラグの確認
   - `payment_status`の確認

3. **日利計算対象の条件**
   - アクティブユーザーの条件
   - NFT承認済みユーザーの条件

## 🔧 推奨される対応策

### 1. 緊急対応
1. **マージン率の修正**
   - 3000% → 30%に修正
   - 管理者画面での設定変更

2. **管理者権限での日利処理確認**
   - 管理者アカウントでのログイン
   - 実際の日利処理の実行

### 2. 詳細調査
1. **RLS制限の回避**
   - 管理者権限での直接クエリ実行
   - 実際のデータ存在確認

2. **日利処理関数の動作確認**
   - `admin_post_yield`関数の詳細テスト
   - エラーログの確認

3. **ユーザー条件の確認**
   - NFT承認済みユーザーの実数
   - 運用開始条件を満たすユーザー

### 3. 長期的な改善
1. **設定値の検証機能**
   - 異常値の入力防止
   - 設定変更時の確認機能

2. **日利処理の監視強化**
   - 自動実行の確認
   - 処理結果の監視

3. **エラーハンドリングの改善**
   - 権限エラーの詳細化
   - 処理失敗時の通知

## 📋 次のステップ

1. **管理者権限でのログイン**
   - 管理者アカウントでのシステムアクセス
   - 実際の日利処理の実行

2. **マージン率の修正**
   - 異常値（3000%）の正常値（30%）への修正
   - 設定変更後の動作確認

3. **詳細なデータ確認**
   - 実際のユーザーデータの確認
   - NFT購入・承認状況の確認

4. **日利処理の実行**
   - 正常な設定での日利処理
   - 処理結果の確認

## 📊 結論

現在のシステムでは、102人のアクティブユーザーと$123,200の投資額があるにも関わらず、日利が0人に配布されている状況です。主な原因は：

1. **マージン率の異常値（3000%）**
2. **管理者権限の制限**
3. **RLSによるデータアクセス制限**

これらの問題を解決することで、正常な日利配布が可能になると考えられます。