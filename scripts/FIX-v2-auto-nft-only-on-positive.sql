-- ========================================
-- 修正: V2関数のNFT自動付与をプラス日利の時のみ実行
-- ========================================
--
-- 問題: マイナス日利の時でもcum_usdt >= 2200のユーザーにNFT付与される
-- 修正: NFT自動付与は「プラス日利の時のみ」実行する
--
-- 修正箇所: process_daily_yield_v2 の360行目付近
-- 修正日: 2025-11-19
-- ========================================

-- ========================================
-- 現在のコード（問題あり）
-- ========================================
/*
-- NFT自動付与（cum_usdt >= $2,200）
FOR v_user_record IN
  SELECT ...
  WHERE ac.cum_usdt >= 2200
LOOP
  ...
END LOOP;
*/

-- ========================================
-- 修正後のコード
-- ========================================
/*
-- NFT自動付与（cum_usdt >= $2,200、プラス日利の時のみ）
IF v_distribution_dividend > 0 THEN
  FOR v_user_record IN
    SELECT ...
    WHERE ac.cum_usdt >= 2200
  LOOP
    ...
  END LOOP;
END IF;
*/

-- ========================================
-- 関数の完全な修正版
-- ========================================
-- 注意: この修正は FIX-process-daily-yield-v2-FINAL-CORRECT.sql を
--       ベースにしているため、先にそちらを適用してください。

-- 修正対象: 357-422行目のNFT自動付与処理
-- 変更点: 外側に IF v_distribution_dividend > 0 THEN ... END IF; を追加
