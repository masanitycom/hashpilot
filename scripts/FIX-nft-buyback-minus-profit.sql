-- NFTè²·ã„å–ã‚Šé‡‘é¡è¨ˆç®—ã®ä¿®æ­£ï¼ˆãƒã‚¤ãƒŠã‚¹åˆ©ç›Šã‚‚Ã·2ã™ã‚‹ï¼‰
-- å•é¡Œ: ãƒã‚¤ãƒŠã‚¹åç›Šã®å ´åˆã€ãã®ã¾ã¾å¼•ã„ã¦ã„ãŸ
-- ä¿®æ­£: ãƒã‚¤ãƒŠã‚¹åç›Šã§ã‚‚Ã·2ã—ã¦å¼•ã

-- ============================================
-- ä¿®æ­£ç‰ˆ: calculate_nft_buyback_amount
-- ============================================
CREATE OR REPLACE FUNCTION calculate_nft_buyback_amount(p_nft_id UUID)
RETURNS DECIMAL(10,2) AS $$
DECLARE
    v_nft_type TEXT;
    v_base_value DECIMAL(10,2);
    v_total_profit DECIMAL(10,3);
    v_buyback_amount DECIMAL(10,2);
BEGIN
    -- NFTæƒ…å ±ã‚’å–å¾—ï¼ˆå€‹äººåç›Šã®ã¿ã‚’ä½¿ç”¨ï¼‰
    SELECT nft_type, nft_value, total_profit_for_buyback
    INTO v_nft_type, v_base_value, v_total_profit
    FROM nft_total_profit
    WHERE nft_id = p_nft_id;

    -- è²·ã„å–ã‚ŠåŸºæœ¬é¡ã‚’æ±ºå®š
    IF v_nft_type = 'manual' THEN
        v_base_value := 1000; -- æ‰‹å‹•è³¼å…¥NFTã¯1000ãƒ‰ãƒ«
    ELSE
        v_base_value := 500;  -- è‡ªå‹•è³¼å…¥/ä»˜ä¸NFTã¯500ãƒ‰ãƒ«
    END IF;

    -- è²·ã„å–ã‚Šé¡ã®è¨ˆç®—
    -- ãƒ—ãƒ©ã‚¹ã®å ´åˆ: åŸºæœ¬é¡ - (å€‹äººåç›Š Ã· 2)
    -- ãƒã‚¤ãƒŠã‚¹ã®å ´åˆ: åŸºæœ¬é¡ + å€‹äººåç›Šï¼ˆãƒã‚¤ãƒŠã‚¹ã‚’ãã®ã¾ã¾è¶³ã™ = å®Ÿè³ªå¼•ãï¼‰
    IF v_total_profit >= 0 THEN
        -- ãƒ—ãƒ©ã‚¹åç›Š: åŠåˆ†ã‚’å¼•ã
        v_buyback_amount := v_base_value - (v_total_profit / 2);
    ELSE
        -- ãƒã‚¤ãƒŠã‚¹åç›Š: ãã®ã¾ã¾è¶³ã™ï¼ˆãƒã‚¤ãƒŠã‚¹ãªã®ã§å®Ÿè³ªå¼•ãï¼‰
        v_buyback_amount := v_base_value + v_total_profit;
    END IF;

    -- 0ä»¥ä¸‹ã«ã¯ãªã‚‰ãªã„
    IF v_buyback_amount < 0 THEN
        v_buyback_amount := 0;
    END IF;

    RETURN v_buyback_amount;
END;
$$ LANGUAGE plpgsql;

-- ============================================
-- æ¤œè¨¼: ä¿®æ­£å¾Œã®è¨ˆç®—çµæœ
-- ============================================

-- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: ãƒ—ãƒ©ã‚¹åç›Šã®å ´åˆ
-- ä¾‹: æ‰‹å‹•NFTã€åç›Š +$15
-- æœŸå¾…å€¤: $1,000 - ($15 Ã· 2) = $992.50

-- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ãƒã‚¤ãƒŠã‚¹åç›Šã®å ´åˆ
-- ä¾‹: æ‰‹å‹•NFTã€åç›Š -$9.12
-- è¨ˆç®—: $1,000 + (-$9.12) = $990.88

-- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: å¤§ããªãƒã‚¤ãƒŠã‚¹åç›Šã®å ´åˆ
-- ä¾‹: æ‰‹å‹•NFTã€åç›Š -$100
-- è¨ˆç®—: $1,000 + (-$100) = $900.00

SELECT 'âœ… NFTè²·ã„å–ã‚Šé‡‘é¡è¨ˆç®—é–¢æ•°ã‚’ä¿®æ­£ã—ã¾ã—ãŸ' as status;
SELECT 'ğŸ“ å¤‰æ›´å†…å®¹:' as info;
SELECT '  - ãƒ—ãƒ©ã‚¹åç›Š: åŸºæœ¬é¡ - (åç›Š Ã· 2)' as change1;
SELECT '  - ãƒã‚¤ãƒŠã‚¹åç›Š: åŸºæœ¬é¡ + åç›Šï¼ˆãƒã‚¤ãƒŠã‚¹ã‚’ãã®ã¾ã¾è¶³ã™ = å®Ÿè³ªå¼•ãï¼‰' as change2;
SELECT '  - ä¸‹é™: 0ãƒ‰ãƒ«ä»¥ä¸‹ã«ã¯ãªã‚‰ãªã„' as change3;
