# ユーザー2BF53B差額問題の解決

## 問題の原因
- データベースの`users`テーブルで`total_purchases = $7700`と記録されている
- 管理画面では$2200と表示されている（正しい値）
- 差額: $5500

## 原因の可能性
1. **手動更新ミス**: 誰かが間違って$7700に更新した
2. **計算エラー**: 購入処理時に金額が誤って加算された
3. **データ移行エラー**: 過去のデータ移行時の問題
4. **重複計算**: 同じ購入が複数回加算された

## 解決方法

### 1. 実際の購入履歴を確認
```sql
-- scripts/fix-user-2BF53B-amount.sql を実行
-- 承認済み購入の実際の合計を確認
```

### 2. 正しい値に修正
```sql
UPDATE users 
SET total_purchases = 2200
WHERE user_id = '2BF53B';
```

### 3. 今後の対策
1. **購入承認時のトリガー追加**
   - 購入承認時に自動的にtotal_purchasesを更新
   - 手動更新を防ぐ

2. **定期的な整合性チェック**
   - purchasesテーブルとusers.total_purchasesの差異を検出
   - 月次でレポート生成

3. **監査ログ**
   - users.total_purchasesの変更履歴を記録
   - 誰がいつ変更したか追跡可能に

## 実行コマンド
```bash
# Supabaseダッシュボードまたは管理ツールで実行
psql -f scripts/fix-user-2BF53B-amount.sql
```

## 確認項目
- [ ] 購入履歴の合計が$2200であることを確認
- [ ] users.total_purchasesを$2200に更新
- [ ] 管理画面とデータベースの値が一致することを確認
- [ ] 他のユーザーで同様の問題がないか確認