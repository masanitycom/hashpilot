# マージン計算ロジック更新

## 📅 更新日: 2025年1月24日

## 🎯 変更内容

### 1. 日利管理のマージン計算
- **旧仕様**: 常に30%のマージンを適用
- **新仕様**: 
  - ✅ **プラス利益時（日利率 > 0）**: 30%マージンを適用
  - ✅ **マイナス利益時（日利率 ≤ 0）**: マージンを引かない

### 2. 計算式の変更

#### プラス利益時
```
実際のマージン率 = 30%
利益（マージン後） = 日利率 × (1 - 0.30)
ユーザー受取率 = 利益（マージン後） × 0.6
会社利益 = 基準金額 × 0.30 + 基準金額 × 利益（マージン後） × 0.1
```

#### マイナス利益時
```
実際のマージン率 = 0%
利益（マージン後） = 日利率（そのまま）
ユーザー受取率 = 日利率 × 0.6
会社利益 = 0
```

### 3. 月末利益確定処理
- 月末処理でも同じロジックを適用
- 当月の累計利益がプラスの場合のみ30%マージンを適用
- マイナスの累計の場合はマージンなし

## 📝 更新ファイル

### フロントエンド
1. `/app/admin/yield/page.tsx`
   - ユーザー受取率の計算ロジックを更新
   - 表示メッセージを条件分岐
   - RPC呼び出し時のパラメータ調整

### バックエンド（SQL関数）
1. `/scripts/update-margin-calculation.sql`
   - `process_daily_yield_with_cycles` 関数の更新（通常版）
   - `process_daily_yield_with_cycles` 関数の更新（月末処理対応版）
   - プラス/マイナス利益時の条件分岐を追加

## ⚠️ 重要な注意事項

1. **本番環境への適用**
   - Supabaseダッシュボードから`update-margin-calculation.sql`を実行してください
   - 実行前に必ずバックアップを取得してください

2. **動作確認**
   - プラス利益（例: 1.6%）を設定し、マージンが適用されることを確認
   - マイナス利益（例: -1.0%）を設定し、マージンが適用されないことを確認

3. **影響範囲**
   - 新規の日利設定から適用
   - 過去のデータには影響なし

## 🔍 テスト方法

### 1. プラス利益のテスト
```sql
SELECT * FROM process_daily_yield_with_cycles('2025-01-24', 0.016, 0.30, true);
-- 期待: margin_rate = 0.30が適用される
```

### 2. マイナス利益のテスト
```sql
SELECT * FROM process_daily_yield_with_cycles('2025-01-24', -0.010, 0.30, true);
-- 期待: margin_rate = 0が適用される
```

### 3. UI確認
1. 管理画面で日利率を入力
2. プラス値: 「1.6% × (1 - 30%/100) × 0.6 = ユーザー受取 0.672%」と表示
3. マイナス値: 「-1.0% × 0.6 = ユーザー受取 -0.600% (マイナス時はマージン無し)」と表示

## ✅ 確認事項

- [ ] SQLファイルをSupabaseに適用
- [ ] フロントエンドのビルドとデプロイ
- [ ] プラス利益時の動作確認
- [ ] マイナス利益時の動作確認
- [ ] 月末処理の動作確認（月末時）

## 📞 サポート

問題が発生した場合は、以下の情報と共に報告してください：
- エラーメッセージ
- 設定した日利率とマージン率
- 実行日時