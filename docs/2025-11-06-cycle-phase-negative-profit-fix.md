# NFTã‚µã‚¤ã‚¯ãƒ«ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šãƒã‚°ä¿®æ­£

**ä¿®æ­£æ—¥**: 2025å¹´11æœˆ6æ—¥
**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: `components/cycle-status-card.tsx`
**ãƒã‚°ã®é‡è¦åº¦**: ğŸ”´ é«˜ï¼ˆãƒ•ã‚§ãƒ¼ã‚ºèª¤è¡¨ç¤ºã«ã‚ˆã‚Šæ··ä¹±ã‚’æ‹›ãï¼‰

---

## ğŸ› ãƒã‚°ã®å†…å®¹

### å•é¡Œã®ç—‡çŠ¶
æœˆé–“åˆ©ç›ŠãŒãƒã‚¤ãƒŠã‚¹ã«ãªã‚‹ã¨ã€**USDTå—å–ãƒ•ã‚§ãƒ¼ã‚º**ãŒ**NFTå—å–ãƒ•ã‚§ãƒ¼ã‚º**ã«èª¤ã£ã¦å¤‰æ›´ã•ã‚Œã¦ã—ã¾ã†ã€‚

### å…·ä½“ä¾‹
- **æœˆé–“ç´¹ä»‹å ±é…¬**: -$500ï¼ˆãƒã‚¤ãƒŠã‚¹åˆ©ç›Šï¼‰
- **æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ**: USDTå—å–ãƒ•ã‚§ãƒ¼ã‚ºã®ã¾ã¾ç¶­æŒ
- **å®Ÿéš›ã®å‹•ä½œ**: NFTå—å–ãƒ•ã‚§ãƒ¼ã‚ºã«èª¤ã£ã¦å¤‰æ›´ã•ã‚Œã‚‹ âŒ

---

## ğŸ” åŸå› åˆ†æ

### ãƒã‚°ã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ï¼ˆä¿®æ­£å‰ï¼‰

```typescript
// line 189-191 (æ—§ã‚³ãƒ¼ãƒ‰)
const cyclesCompleted = Math.floor(totalProfit / 1100)
const remainingProfit = totalProfit % 1100
const nextAction = cyclesCompleted % 2 === 0 ? 'usdt' : 'nft'
```

### ãªãœãƒã‚°ãŒç™ºç”Ÿã™ã‚‹ã‹

**Math.floor()ã®æŒ™å‹•:**
- ãƒ—ãƒ©ã‚¹å€¤: `Math.floor(500 / 1100) = 0` â†’ OK
- **ãƒã‚¤ãƒŠã‚¹å€¤**: `Math.floor(-500 / 1100) = Math.floor(-0.45) = -1` â†’ NG

**cyclesCompletedã®è¨ˆç®—:**
- é€šå¸¸: `0 % 2 === 0` â†’ `true` â†’ USDTå—å–ãƒ•ã‚§ãƒ¼ã‚º âœ…
- ãƒã‚¤ãƒŠã‚¹æ™‚: `-1 % 2 === 0` â†’ `false` â†’ NFTå—å–ãƒ•ã‚§ãƒ¼ã‚º âŒ

**çµæœ:**
ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šã«ã‚ˆã‚Š`cyclesCompleted`ãŒè² ã®æ•°ã«ãªã‚Šã€å¶æ•°/å¥‡æ•°åˆ¤å®šãŒåè»¢ã—ã¦ãƒ•ã‚§ãƒ¼ã‚ºãŒèª¤ã£ã¦å¤‰æ›´ã•ã‚Œã‚‹ã€‚

---

## âœ… ä¿®æ­£å†…å®¹

### ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰

```typescript
// line 188-193 (æ–°ã‚³ãƒ¼ãƒ‰)
// 1100ãƒ‰ãƒ«ã‚µã‚¤ã‚¯ãƒ«è¨ˆç®—
// ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šã®å ´åˆã¯0ã¨ã—ã¦æ‰±ã†ï¼ˆãƒ•ã‚§ãƒ¼ã‚ºå¤‰æ›´ã‚’é˜²ãï¼‰
const effectiveProfit = Math.max(0, totalProfit)
const cyclesCompleted = Math.floor(effectiveProfit / 1100)
const remainingProfit = effectiveProfit % 1100
const nextAction = cyclesCompleted % 2 === 0 ? 'usdt' : 'nft'
```

### ä¿®æ­£ã®èª¬æ˜

**`Math.max(0, totalProfit)`ã‚’ä½¿ç”¨:**
- ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šã®å ´åˆ â†’ `0`ã¨ã—ã¦æ‰±ã†
- ãƒ—ãƒ©ã‚¹åˆ©ç›Šã®å ´åˆ â†’ ãã®ã¾ã¾ä½¿ç”¨

**å‹•ä½œä¾‹:**
- æœˆé–“åˆ©ç›Š: -$500 â†’ `effectiveProfit = 0`
- `cyclesCompleted = Math.floor(0 / 1100) = 0`
- `0 % 2 === 0` â†’ `true` â†’ USDTå—å–ãƒ•ã‚§ãƒ¼ã‚º âœ…

---

## ğŸ”§ è¿½åŠ ä¿®æ­£

### getNextMilestoneé–¢æ•°ã‚‚ä¿®æ­£

```typescript
// line 236-253 (ä¿®æ­£å¾Œ)
const getNextMilestone = (currentProfit: number, nextAction: string) => {
  // ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šã®å ´åˆã¯0ã¨ã—ã¦æ‰±ã†
  const effectiveProfit = Math.max(0, currentProfit)
  const remaining = 1100 - effectiveProfit
  if (remaining <= 0) {
    return {
      target: 1100,
      label: nextAction === 'nft' ? "NFTè³¼å…¥æº–å‚™å®Œäº†" : "USDTå—å–æº–å‚™å®Œäº†",
      remaining: 0
    }
  } else {
    return {
      target: 1100,
      label: nextAction === 'nft' ? "NFTè³¼å…¥ã¾ã§" : "USDTå—å–ã¾ã§",
      remaining: remaining
    }
  }
}
```

**ç†ç”±:**
ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šæ™‚ã«ã€Œã‚ã¨$1,600ã€ã®ã‚ˆã†ãªèª¤è¡¨ç¤ºã‚’é˜²ããŸã‚ã€‚

---

## ğŸ“Š ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

### ã‚±ãƒ¼ã‚¹1: é€šå¸¸ã®ãƒ—ãƒ©ã‚¹åˆ©ç›Š
- **å…¥åŠ›**: `totalProfit = 500`
- **çµæœ**: `cyclesCompleted = 0`, `nextAction = 'usdt'` âœ…
- **è¡¨ç¤º**: "USDTå—å–ãƒ•ã‚§ãƒ¼ã‚º", "ã‚ã¨$600"

### ã‚±ãƒ¼ã‚¹2: ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šï¼ˆãƒã‚°ä¿®æ­£å‰ï¼‰
- **å…¥åŠ›**: `totalProfit = -500`
- **çµæœï¼ˆæ—§ï¼‰**: `cyclesCompleted = -1`, `nextAction = 'nft'` âŒ
- **è¡¨ç¤ºï¼ˆæ—§ï¼‰**: "NFTå—å–ãƒ•ã‚§ãƒ¼ã‚º", "ã‚ã¨$1,600" â† èª¤ã‚Š

### ã‚±ãƒ¼ã‚¹3: ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šï¼ˆãƒã‚°ä¿®æ­£å¾Œï¼‰
- **å…¥åŠ›**: `totalProfit = -500`
- **çµæœï¼ˆæ–°ï¼‰**: `effectiveProfit = 0`, `cyclesCompleted = 0`, `nextAction = 'usdt'` âœ…
- **è¡¨ç¤ºï¼ˆæ–°ï¼‰**: "USDTå—å–ãƒ•ã‚§ãƒ¼ã‚º", "ã‚ã¨$1,100" â† æ­£ã—ã„

### ã‚±ãƒ¼ã‚¹4: 1100ãƒ‰ãƒ«åˆ°é”
- **å…¥åŠ›**: `totalProfit = 1100`
- **çµæœ**: `cyclesCompleted = 1`, `nextAction = 'nft'` âœ…
- **è¡¨ç¤º**: "NFTå—å–ãƒ•ã‚§ãƒ¼ã‚º", "æº–å‚™å®Œäº†"

### ã‚±ãƒ¼ã‚¹5: 2200ãƒ‰ãƒ«åˆ°é”
- **å…¥åŠ›**: `totalProfit = 2200`
- **çµæœ**: `cyclesCompleted = 2`, `nextAction = 'usdt'` âœ…
- **è¡¨ç¤º**: "USDTå—å–ãƒ•ã‚§ãƒ¼ã‚º", "æº–å‚™å®Œäº†"

---

## ğŸ¯ å½±éŸ¿ç¯„å›²

### ä¿®æ­£ã•ã‚ŒãŸæ©Ÿèƒ½
1. âœ… NFTã‚µã‚¤ã‚¯ãƒ«ãƒ•ã‚§ãƒ¼ã‚ºã®æ­£ç¢ºãªè¡¨ç¤º
2. âœ… é€²æ—ãƒãƒ¼ã®æ­£ç¢ºãªè¡¨ç¤ºï¼ˆ0%ï¼‰
3. âœ… æ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã¾ã§ã®è·é›¢è¡¨ç¤º

### å½±éŸ¿ã‚’å—ã‘ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼
- ãƒã‚¤ãƒŠã‚¹æ—¥åˆ©ãŒç™ºç”Ÿã—ãŸæœˆã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
- ç´¹ä»‹å ±é…¬ãŒãƒã‚¤ãƒŠã‚¹ã«ãªã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ã®å½±éŸ¿
- **ãªã—** - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¡¨ç¤ºã®ã¿ã®ä¿®æ­£
- RPCé–¢æ•°ã‚„ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—

---

## ğŸ“ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

### ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
```bash
git add components/cycle-status-card.tsx
git add docs/2025-11-06-cycle-phase-negative-profit-fix.md
git commit -m "NFTã‚µã‚¤ã‚¯ãƒ«ãƒ•ã‚§ãƒ¼ã‚ºã®ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šãƒã‚°ä¿®æ­£

- ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šæ™‚ã«ãƒ•ã‚§ãƒ¼ã‚ºãŒèª¤ã£ã¦å¤‰æ›´ã•ã‚Œã‚‹å•é¡Œã‚’ä¿®æ­£
- Math.max(0, totalProfit)ã§è² ã®å€¤ã‚’0ã¨ã—ã¦æ‰±ã†
- getNextMilestoneé–¢æ•°ã‚‚åŒæ§˜ã«ä¿®æ­£
- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã¨ä¿®æ­£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ "
git push origin staging
```

### æœ¬ç•ªç’°å¢ƒ
```bash
git checkout main
git merge staging
git push origin main
```

---

## âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …

1. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¡¨ç¤ºã®ã¿ã®ä¿®æ­£**
   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚µã‚¤ã‚¯ãƒ«è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ã—ã¦ã„ãªã„
   - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰RPCé–¢æ•°ã¯å½±éŸ¿ã‚’å—ã‘ãªã„

2. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¸ã®å½±éŸ¿ãªã—**
   - éå»ã®ã‚µã‚¤ã‚¯ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯å¤‰æ›´ã•ã‚Œãªã„
   - è¡¨ç¤ºãŒæ­£ç¢ºã«ãªã‚‹ã ã‘

3. **ä»–ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨ã®æ•´åˆæ€§**
   - `referral-profit-card.tsx`ã®ç´¹ä»‹å ±é…¬è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã¨ã¯ç‹¬ç«‹
   - `affiliate_cycle`ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã¨æ•´åˆæ€§ã‚’ä¿ã¤

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- `components/cycle-status-card.tsx` - ãƒ¡ã‚¤ãƒ³ä¿®æ­£ãƒ•ã‚¡ã‚¤ãƒ«
- `app/dashboard/page.tsx` - ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤ºã™ã‚‹ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- `CLAUDE.md` - ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†ã‚¬ã‚¤ãƒ‰ï¼ˆNFTã‚µã‚¤ã‚¯ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

---

## ğŸ“ æ¤œè¨¼æ–¹æ³•

### ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ç¢ºèª
1. https://hashpilot-staging.vercel.app/dashboard ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
3. NFTã‚µã‚¤ã‚¯ãƒ«çŠ¶æ³ã‚«ãƒ¼ãƒ‰ã®ãƒ•ã‚§ãƒ¼ã‚ºè¡¨ç¤ºã‚’ç¢ºèª
4. é€²æ—ãƒãƒ¼ã¨æ®‹ã‚Šé‡‘é¡ãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### æœŸå¾…ã•ã‚Œã‚‹çµæœ
- ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šæ™‚: USDTå—å–ãƒ•ã‚§ãƒ¼ã‚ºã®ã¾ã¾ç¶­æŒ
- é€²æ—ãƒãƒ¼: 0%è¡¨ç¤º
- æ¬¡ã®ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³: "ã‚ã¨$1,100"

---

**ä¿®æ­£å®Œäº†** âœ…
