# マージン計算ロジック修正 v2

## 📅 修正日: 2025年1月24日

## 🐛 修正した問題

### 問題の内容
マイナス利益設定時（例: -0.2%）で、ユーザー受取率が誤って計算されていた：
- **誤った表示**: -0.840%
- **正しい表示**: -0.120%

### 原因
フロントエンドの計算ロジックで、マイナス時もマージンが適用されていた

## ✅ 修正内容

### 1. `/app/admin/yield/page.tsx` の修正

#### ユーザー受取率計算（useEffect）
```javascript
// 修正前
const after_margin = yield_rate  // マイナスでも同じ変数を使用
const calculated_user_rate = after_margin * 0.6

// 修正後
if (yield_rate > 0) {
  const after_margin = yield_rate * (1 - margin_rate / 100)
  calculated_user_rate = after_margin * 0.6
} else {
  calculated_user_rate = yield_rate * 0.6  // マイナス時は直接0.6を掛ける
}
```

#### テスト計算関数（simulateYieldCalculation）
```javascript
// 修正前
const user_rate = yield_rate * (1 - margin_rate) * 0.6  // 常にマージン適用

// 修正後
if (yield_rate > 0) {
  user_rate = yield_rate * (1 - margin_rate) * 0.6
} else {
  user_rate = yield_rate * 0.6  // マイナス時はマージンなし
}
```

## 📊 計算例

### プラス利益時（+1.6%、マージン30%）
```
日利率: 1.6%
マージン後: 1.6% × (1 - 0.30) = 1.12%
ユーザー受取率: 1.12% × 0.6 = 0.672%
```

### マイナス利益時（-0.2%、マージン設定は30%だが適用されない）
```
日利率: -0.2%
マージン後: -0.2%（マージン適用なし）
ユーザー受取率: -0.2% × 0.6 = -0.120%
```

## 🔍 動作確認方法

### 1. ブラウザで確認
1. 管理画面の日利設定ページにアクセス
2. 日利率に「-0.2」を入力
3. マージン率は「30」のまま
4. **ユーザー受取率が「-0.120%」と表示されることを確認**

### 2. 計算式の表示確認
- プラス時: `1.6% × (1 - 30%/100) × 0.6 = ユーザー受取 0.672%`
- マイナス時: `-0.2% × 0.6 = ユーザー受取 -0.120% (マイナス時はマージン無し)`

## 📝 デプロイ手順

1. **フロントエンドのビルド**
   ```bash
   npm run build
   ```

2. **デプロイ**
   ```bash
   # Vercelなどのデプロイコマンド
   ```

3. **SQL関数は既に更新済み**
   - `/scripts/update-margin-calculation.sql` は適用済みであることを確認

## ⚠️ 注意事項

- この修正はフロントエンドの表示のみ
- バックエンド（SQL関数）は既に正しく実装されている
- キャッシュクリアが必要な場合がある

## ✅ チェックリスト

- [ ] フロントエンドのビルド完了
- [ ] デプロイ完了
- [ ] プラス利益時の表示確認（例: +1.6% → 0.672%）
- [ ] マイナス利益時の表示確認（例: -0.2% → -0.120%）
- [ ] テスト機能での動作確認