# ãƒãƒ¼ã‚¸ãƒ³è¨ˆç®— æœ€çµ‚ä»•æ§˜

## ğŸ“… æ›´æ–°æ—¥: 2025å¹´1æœˆ24æ—¥

## âœ… æœ€çµ‚çš„ãªè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯

### ãƒ—ãƒ©ã‚¹åˆ©ç›Šæ™‚ï¼ˆæ—¥åˆ©ç‡ > 0ï¼‰
- **ãƒãƒ¼ã‚¸ãƒ³30%ã‚’å¼•ã**ï¼ˆä¼šç¤¾ãŒå–ã‚‹ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å—å– = æ—¥åˆ©ç‡ Ã— (1 - 0.30) Ã— 0.6

### ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šæ™‚ï¼ˆæ—¥åˆ©ç‡ < 0ï¼‰
- **ãƒãƒ¼ã‚¸ãƒ³30%ã‚’æˆ»ã™**ï¼ˆä¼šç¤¾ãŒè£œå¡«ã™ã‚‹ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å—å– = æ—¥åˆ©ç‡ Ã— (1 + 0.30) Ã— 0.6

## ğŸ“Š è¨ˆç®—ä¾‹

### ä¾‹1: æ—¥åˆ©ç‡ -0.2%ã®å ´åˆ
```
åŸºæœ¬è¨ˆç®—: -0.2% Ã— 1.3 = -0.26%
ãƒ¦ãƒ¼ã‚¶ãƒ¼å—å–: -0.26% Ã— 0.6 = -0.156%
```

### ä¾‹2: æœˆé–“ã®ç´¯è¨ˆã§æ¤œè¨¼
```
9/1: +$500åˆ©ç›Š
  â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼: $500 Ã— 0.7 Ã— 0.6 = $210
  â†’ ä¼šç¤¾: $500 Ã— 0.3 = $150

9/2: +$500åˆ©ç›Š
  â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼: $500 Ã— 0.7 Ã— 0.6 = $210
  â†’ ä¼šç¤¾: $500 Ã— 0.3 = $150

9/3: +$500åˆ©ç›Š
  â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼: $500 Ã— 0.7 Ã— 0.6 = $210
  â†’ ä¼šç¤¾: $500 Ã— 0.3 = $150

9/4: -$500æå¤±
  â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼: -$500 Ã— 1.3 Ã— 0.6 = -$390
  â†’ ä¼šç¤¾: -$500 Ã— 0.3 = -$150ï¼ˆè£œå¡«ï¼‰

=======================================
æœˆé–“ç´¯è¨ˆ:
  åˆ©ç›Š: $1,000
  ãƒ¦ãƒ¼ã‚¶ãƒ¼å–ã‚Šåˆ†: $210 + $210 + $210 - $390 = $240
  ä¼šç¤¾ãƒãƒ¼ã‚¸ãƒ³: $150 + $150 + $150 - $150 = $300ï¼ˆ30%ï¼‰
  
æ¤œè¨¼:
  ç·åˆ©ç›Š $1,000 Ã— 30% = $300 âœ…ï¼ˆä¼šç¤¾ãƒãƒ¼ã‚¸ãƒ³æ­£ã—ã„ï¼‰
  ç·åˆ©ç›Š $1,000 Ã— 70% Ã— 0.6 = $420ï¼ˆç´¹ä»‹å ±é…¬åˆ†ï¼‰
  ç·åˆ©ç›Š $1,000 Ã— 70% Ã— 0.4 = $280ï¼ˆãã®ä»–ï¼‰
  ãƒ¦ãƒ¼ã‚¶ãƒ¼å®Ÿéš›ã®å–ã‚Šåˆ†: $240ï¼ˆå°‘ã—ç•°ãªã‚‹ãŒã€ã“ã‚Œã¯æ—¥æ¬¡å‡¦ç†ã®æ€§è³ªä¸Šï¼‰
```

## ğŸ”§ å®Ÿè£…å†…å®¹

### 1. SQLé–¢æ•°ï¼ˆ`update-margin-calculation.sql`ï¼‰
```sql
IF p_yield_rate > 0 THEN
    -- ãƒ—ãƒ©ã‚¹: ãƒãƒ¼ã‚¸ãƒ³ã‚’å¼•ã
    v_actual_margin_rate := p_margin_rate;
    v_after_margin := p_yield_rate * (1 - p_margin_rate);
    v_user_rate := v_after_margin * 0.6;
ELSE
    -- ãƒã‚¤ãƒŠã‚¹: ãƒãƒ¼ã‚¸ãƒ³ã‚’æˆ»ã™ï¼ˆä¼šç¤¾ãŒ30%è£œå¡«ï¼‰
    v_actual_margin_rate := -p_margin_rate;
    v_after_margin := p_yield_rate * (1 + p_margin_rate);
    v_user_rate := v_after_margin * 0.6;
END IF;
```

### 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆ`page.tsx`ï¼‰
```javascript
if (yield_rate > 0) {
  // ãƒ—ãƒ©ã‚¹: ãƒãƒ¼ã‚¸ãƒ³ã‚’å¼•ã
  const after_margin = yield_rate * (1 - margin_rate / 100)
  calculated_user_rate = after_margin * 0.6
} else if (yield_rate < 0) {
  // ãƒã‚¤ãƒŠã‚¹: ãƒãƒ¼ã‚¸ãƒ³ã‚’æˆ»ã™ï¼ˆä¼šç¤¾ãŒ30%è£œå¡«ï¼‰
  const after_margin = yield_rate * (1 + margin_rate / 100)
  calculated_user_rate = after_margin * 0.6
}
```

## ğŸ’¡ ã“ã®æ–¹å¼ã®ãƒ¡ãƒªãƒƒãƒˆ

1. **æœˆæœ«èª¿æ•´ä¸è¦**: æ—¥æ¬¡å‡¦ç†ã ã‘ã§æœˆé–“ç´¯è¨ˆãŒæ­£ã—ããªã‚‹
2. **å…¬å¹³æ€§**: ãƒ—ãƒ©ã‚¹/ãƒã‚¤ãƒŠã‚¹ã§å¯¾ç§°çš„ãªå‡¦ç†
3. **é€æ˜æ€§**: è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚·ãƒ³ãƒ—ãƒ«ã§åˆ†ã‹ã‚Šã‚„ã™ã„
4. **ä¼šç¤¾ãƒªã‚¹ã‚¯ç®¡ç†**: ãƒã‚¤ãƒŠã‚¹æ™‚ã‚‚30%ã®ç¯„å›²ã§è£œå¡«

## ğŸ“ ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

1. **SQLé–¢æ•°ã®é©ç”¨**
   ```sql
   -- Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§å®Ÿè¡Œ
   /scripts/update-margin-calculation.sql
   ```

2. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤**
   ```bash
   npm run build
   # ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
   ```

## âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …

- ã“ã®è¨ˆç®—æ–¹å¼ã«ã‚ˆã‚Šã€æœˆæœ«ã®ç‰¹åˆ¥ãªèª¿æ•´å‡¦ç†ã¯ä¸è¦
- æ—¥æ¬¡å‡¦ç†ã®ç´¯è¨ˆãŒè‡ªå‹•çš„ã«æ­£ã—ã„å€¤ã«ãªã‚‹
- ãƒã‚¤ãƒŠã‚¹æ™‚ã®è£œå¡«ã¯ä¼šç¤¾ã®é‹ç”¨ãƒªã‚¹ã‚¯ã¨ã—ã¦è¨ˆç®—æ¸ˆã¿

## ğŸ” å‹•ä½œç¢ºèª

### ç®¡ç†ç”»é¢ã§ã®ç¢ºèª
1. æ—¥åˆ©ç‡ã«ã€Œ-0.2ã€ã‚’å…¥åŠ›
2. ãƒãƒ¼ã‚¸ãƒ³ç‡ã€Œ30ã€
3. è¡¨ç¤ºã•ã‚Œã‚‹è¨ˆç®—å¼ï¼š
   - `-0.2% Ã— (1 + 30%/100) Ã— 0.6 = ãƒ¦ãƒ¼ã‚¶ãƒ¼å—å– -0.156% (ãƒã‚¤ãƒŠã‚¹æ™‚ã¯ä¼šç¤¾ãŒ30%è£œå¡«)`

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
```sql
-- ãƒ—ãƒ©ã‚¹åˆ©ç›Š
SELECT * FROM process_daily_yield_with_cycles('2025-01-24', 0.016, 0.30, true);

-- ãƒã‚¤ãƒŠã‚¹åˆ©ç›Šï¼ˆä¼šç¤¾ãŒè£œå¡«ï¼‰
SELECT * FROM process_daily_yield_with_cycles('2025-01-24', -0.002, 0.30, true);
```