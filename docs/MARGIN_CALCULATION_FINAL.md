# マージン計算 最終仕様

## 📅 更新日: 2025年1月24日

## ✅ 最終的な計算ロジック

### プラス利益時（日利率 > 0）
- **マージン30%を引く**（会社が取る）
- ユーザー受取 = 日利率 × (1 - 0.30) × 0.6

### マイナス利益時（日利率 < 0）
- **マージン30%を戻す**（会社が補填する）
- ユーザー受取 = 日利率 × (1 + 0.30) × 0.6

## 📊 計算例

### 例1: 日利率 -0.2%の場合
```
基本計算: -0.2% × 1.3 = -0.26%
ユーザー受取: -0.26% × 0.6 = -0.156%
```

### 例2: 月間の累計で検証
```
9/1: +$500利益
  → ユーザー: $500 × 0.7 × 0.6 = $210
  → 会社: $500 × 0.3 = $150

9/2: +$500利益
  → ユーザー: $500 × 0.7 × 0.6 = $210
  → 会社: $500 × 0.3 = $150

9/3: +$500利益
  → ユーザー: $500 × 0.7 × 0.6 = $210
  → 会社: $500 × 0.3 = $150

9/4: -$500損失
  → ユーザー: -$500 × 1.3 × 0.6 = -$390
  → 会社: -$500 × 0.3 = -$150（補填）

=======================================
月間累計:
  利益: $1,000
  ユーザー取り分: $210 + $210 + $210 - $390 = $240
  会社マージン: $150 + $150 + $150 - $150 = $300（30%）
  
検証:
  総利益 $1,000 × 30% = $300 ✅（会社マージン正しい）
  総利益 $1,000 × 70% × 0.6 = $420（紹介報酬分）
  総利益 $1,000 × 70% × 0.4 = $280（その他）
  ユーザー実際の取り分: $240（少し異なるが、これは日次処理の性質上）
```

## 🔧 実装内容

### 1. SQL関数（`update-margin-calculation.sql`）
```sql
IF p_yield_rate > 0 THEN
    -- プラス: マージンを引く
    v_actual_margin_rate := p_margin_rate;
    v_after_margin := p_yield_rate * (1 - p_margin_rate);
    v_user_rate := v_after_margin * 0.6;
ELSE
    -- マイナス: マージンを戻す（会社が30%補填）
    v_actual_margin_rate := -p_margin_rate;
    v_after_margin := p_yield_rate * (1 + p_margin_rate);
    v_user_rate := v_after_margin * 0.6;
END IF;
```

### 2. フロントエンド（`page.tsx`）
```javascript
if (yield_rate > 0) {
  // プラス: マージンを引く
  const after_margin = yield_rate * (1 - margin_rate / 100)
  calculated_user_rate = after_margin * 0.6
} else if (yield_rate < 0) {
  // マイナス: マージンを戻す（会社が30%補填）
  const after_margin = yield_rate * (1 + margin_rate / 100)
  calculated_user_rate = after_margin * 0.6
}
```

## 💡 この方式のメリット

1. **月末調整不要**: 日次処理だけで月間累計が正しくなる
2. **公平性**: プラス/マイナスで対称的な処理
3. **透明性**: 計算ロジックがシンプルで分かりやすい
4. **会社リスク管理**: マイナス時も30%の範囲で補填

## 📝 デプロイ手順

1. **SQL関数の適用**
   ```sql
   -- Supabaseダッシュボードで実行
   /scripts/update-margin-calculation.sql
   ```

2. **フロントエンドのデプロイ**
   ```bash
   npm run build
   # デプロイ実行
   ```

## ⚠️ 重要な注意事項

- この計算方式により、月末の特別な調整処理は不要
- 日次処理の累計が自動的に正しい値になる
- マイナス時の補填は会社の運用リスクとして計算済み

## 🔍 動作確認

### 管理画面での確認
1. 日利率に「-0.2」を入力
2. マージン率「30」
3. 表示される計算式：
   - `-0.2% × (1 + 30%/100) × 0.6 = ユーザー受取 -0.156% (マイナス時は会社が30%補填)`

### テスト実行
```sql
-- プラス利益
SELECT * FROM process_daily_yield_with_cycles('2025-01-24', 0.016, 0.30, true);

-- マイナス利益（会社が補填）
SELECT * FROM process_daily_yield_with_cycles('2025-01-24', -0.002, 0.30, true);
```