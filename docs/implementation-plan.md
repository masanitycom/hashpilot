# HashPilot Affiliate Reward System - 実装計画

## 実装戦略: 本番環境での独立実装 + 機能フラグ

### Phase 1: データベーススキーマ作成（既存システムに影響なし）
- [ ] 新テーブル群の作成
- [ ] RLS ポリシーの設定
- [ ] インデックスの作成
- [ ] 機能フラグテーブルの作成

### Phase 2: 基本RPC関数実装
- [ ] admin_post_yield() - 日利設定
- [ ] updateAffiliateCycle() - サイクル管理
- [ ] get_user_nft_holdings() - NFT保有状況取得
- [ ] fetch_dashboard() - ダッシュボードデータ

### Phase 3: Edge Function（日次バッチ処理）
- [ ] 日次利益計算
- [ ] 紹介報酬計算
- [ ] NFT自動購入処理
- [ ] 会社利益記録

### Phase 4: Cron設定（月次クローズ）
- [ ] 月次サマリー生成
- [ ] 出金キュー作成
- [ ] データアーカイブ

### Phase 5: フロントエンド（ユーザーダッシュボード）
- [ ] NFT保有状況表示（タイプ別）
- [ ] サイクル進捗表示
- [ ] 日次履歴表示
- [ ] 確定報酬表示

### Phase 6: 管理画面拡張
- [ ] 日利設定画面
- [ ] NFT保有状況管理
- [ ] サイクル一覧表示
- [ ] 出金管理

### Phase 7: 機能フラグ管理
- [ ] 管理画面での機能ON/OFF切り替え
- [ ] 緊急停止機能
- [ ] 段階的ユーザー適用

### Phase 8: テスト・デバッグ
- [ ] 単体テスト
- [ ] 統合テスト
- [ ] パフォーマンステスト
- [ ] セキュリティテスト

## 安全対策

### 1. 既存システム保護
- ✅ 既存テーブル構造は一切変更しない
- ✅ 既存RPC関数は一切触らない
- ✅ 既存紹介ロジックは完全保護
- ✅ 新機能は完全に独立したテーブル群

### 2. 機能フラグによる制御
- ✅ デフォルトで全機能OFF
- ✅ 管理者による段階的有効化
- ✅ 緊急時の即座無効化
- ✅ ユーザー単位での適用制御

### 3. データ整合性保証
- ✅ トランザクション処理
- ✅ 制約条件の設定
- ✅ バックアップ・復旧手順
- ✅ ロールバック機能

### 4. 監視・ログ
- ✅ 処理ログの記録
- ✅ エラー監視
- ✅ パフォーマンス監視
- ✅ アラート設定

## NFT区別機能の詳細

### nft_holdings テーブル拡張
\`\`\`sql
-- NFTタイプの明確な区別
type: 'manual_purchase' | 'auto_buy' | 'affiliate_bonus'

-- 追加情報
purchase_amount_usd: 手動購入時の実際の支払額
cycle_id: 自動購入時のサイクル番号
transaction_hash: 手動購入時のトランザクション
\`\`\`

### 表示での区別
- 🛒 手動購入NFT: ユーザーがUSDTで直接購入
- 🔄 自動購入NFT: サイクル2200到達時に自動購入
- 🎁 ボーナスNFT: 紹介報酬として付与（将来拡張）

### 利益計算での統合
- 手動購入・自動購入NFT両方から日利を計算
- NFTタイプに関係なく、保有数×1000×利率で計算
- 管理画面でタイプ別の統計表示

## 次のステップ

1. **Phase 1の開始準備**
   - データベーススキーマの詳細設計
   - 機能フラグテーブルの設計
   - 既存システムとの連携ポイント確認

2. **テスト環境での検証**
   - 新テーブル作成のテスト
   - RLS設定の確認
   - 既存システムへの影響確認

準備ができましたら、Phase 1から実装を開始します！
