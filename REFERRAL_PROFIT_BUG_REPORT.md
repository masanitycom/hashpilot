# 🚨 紹介報酬計算の重大なバグ発見

**日付**: 2025年12月1日
**影響範囲**: 11月全体の紹介報酬計算
**推定損害額**: 約$272〜$4,786（調査中）

---

## 📋 問題の概要

**発見されたバグ:**
1. **V1システムのバグ1**: 紹介報酬が `cum_usdt` に加算されるが、`available_usdt` に加算されていない → 修正済み（`FIX-v1-add-available-usdt-to-referral.sql`）
2. **V1システムのバグ2**: **子ユーザーの日利が$0なのに、紹介報酬が記録されている** ← **新発見！**

---

## 🔍 バグ2の詳細分析（ユーザー177B83の例）

### 発見の経緯

ユーザー177B83の11月の紹介報酬を調査した結果:

```
個人利益: $32.014 (1 NFT × 30日)
紹介報酬: $1,373.890 ← 43倍も多い！

内訳:
- Level 1: $80.872
- Level 2: $1,259.026 ← 異常に高い
- Level 3: $33.992
```

### Level 2紹介報酬の詳細

```
レコード数: 300件
ユニーク子ユーザー数: 22名
合計金額: $1,259.026

期待値: $987.010（子ユーザーの実際の日利 × 10%）
実際: $1,259.026
差額: $272.016 ← 27.5%過大配布
```

### 具体的な異常例（11/26のデータ）

| 子ユーザーID | メール | 実際の日利 | 記録された報酬 | 期待値(10%) | 差額 | NFT数 |
|------------|--------|----------|--------------|------------|------|------|
| 039483 | mayumi.j0222ayc@ezweb.ne.jp | **$0.00** | **$0.798** | $0.00 | **+$0.798** | 1個 |
| 1DEFED | yuki.shirai1949@gmail.com | **$0.00** | **$0.798** | $0.00 | **+$0.798** | 1個 |
| 2D378C | miyaeri136@gmail.com | **$0.00** | **$0.798** | $0.00 | **+$0.798** | 1個 |
| 6FF2D1 | happy.magic.51@gmail.com | **$0.00** | **$0.798** | $0.00 | **+$0.798** | 1個 |

**発見:**
- これらのユーザーは`user_daily_profit`に11/26のレコードが**存在しない**
- にもかかわらず、親ユーザーに$0.798の紹介報酬が配布されている
- $0.798 = 1 NFT × $7.98（11/26の1 NFT日利） × 10%（Level 2）

---

## 💡 バグの原因（推定）

**V1関数（`process_daily_yield_with_cycles`）の問題点:**

紹介報酬計算時に、**子ユーザーの実際の日利を参照せず**、以下の計算をしている可能性:

```sql
-- 間違った計算（推定）:
v_user_profit := (子ユーザーのNFT数) × (1 NFTの日利)

-- 正しい計算:
v_user_profit := user_daily_profitテーブルの実際の金額
```

**なぜ日利が$0なのか？**

以下のいずれかが原因:
1. **運用開始日未到達**: `operation_start_date > 配布日`
2. **運用開始日未設定**: `operation_start_date IS NULL`
3. **NFT承認フラグ未設定**: `has_approved_nft = false`

これらのユーザーは日利が配布されないが、紹介報酬は計算されてしまう。

---

## 📊 影響範囲の推定

### ユーザー177B83の場合:
- **Level 2の過大配布**: $272.016
- **11月全体の過大配布**: 約$300（Level 1/3も含む）

### 全システムの影響:
- **11月の紹介報酬合計**: $13,357.747
- **期待値**: $8,572.034（個人利益 × 35%）
- **過大配布**: $4,785.713（**56%も多い！**）

**内訳:**
- Level 1（20%）: 実際 $5,789 vs 期待 $4,898 → +$891
- Level 2（10%）: 実際 $5,824 vs 期待 $2,449 → **+$3,375**
- Level 3（5%）: 実際 $1,745 vs 期待 $1,225 → +$520

→ **Level 2が最も深刻**（約$3,400の過大配布）

---

## 🔧 修正方針

### STEP 1: 詳細調査
```bash
scripts/CHECK-level2-daily-profit-zero-bug.sql
```
- 日利$0だが紹介報酬ありのレコード数
- 誤配布の合計金額
- 影響を受けたユーザー数
- $0.798の金額の由来

### STEP 2: V1関数の修正
`process_daily_yield_with_cycles`関数のSTEP 3（紹介報酬計算）を修正:

**修正前（推定）:**
```sql
-- NFT数から計算（間違い）
v_user_profit := (SELECT COUNT(*) FROM nft_master ...) * (日利 / 総NFT数)
```

**修正後:**
```sql
-- user_daily_profitテーブルから取得（正しい）
SELECT daily_profit INTO v_user_profit
FROM user_daily_profit
WHERE user_id = v_child_user_id AND date = p_date;

-- レコードがない場合は紹介報酬なし
IF v_user_profit IS NULL THEN
  v_user_profit := 0;
END IF;
```

### STEP 3: 誤配布データの削除
⚠️ **慎重に実行する必要あり**

1. `affiliate_cycle`から誤配布額を減算
2. `user_referral_profit`から該当レコードを削除

---

## 📝 管理者への報告内容

### 問題の要約
紹介報酬計算システムに重大なバグが発見されました。子ユーザーが運用開始していない（日利$0）にもかかわらず、親ユーザーに紹介報酬が配布されていました。

### 影響範囲
- **期間**: 2025年11月全体（11/1〜11/30）
- **過大配布額**: 約$4,786（56%過大）
- **影響ユーザー**: 調査中（数十名〜数百名の可能性）

### 原因
V1日利処理システムの紹介報酬計算ロジックにおいて、子ユーザーの**実際の日利**ではなく、**NFT数から計算した仮想日利**を使用していたため。

### 対策
1. V1関数の修正（子ユーザーの実際の日利を参照するように修正）
2. 誤配布データの削除（`affiliate_cycle`と`user_referral_profit`から削除）
3. V2システムへの移行を検討（V2では既に修正済み）

---

## 🔗 関連ファイル

**調査スクリプト:**
- `scripts/CHECK-user-177B83-november-totals.sql` - ユーザー177B83の11月合計
- `scripts/CHECK-177B83-level2-detail.sql` - Level 2詳細調査
- `scripts/check_177B83_level2.js` - 実行スクリプト（Node.js）
- `scripts/CHECK-level2-daily-profit-zero-bug.sql` - バグの詳細確認

**修正スクリプト（作成予定）:**
- `scripts/FIX-v1-referral-use-actual-daily-profit.sql` - V1関数修正
- `scripts/DELETE-incorrect-referral-november.sql` - 誤配布データ削除

**ドキュメント:**
- `REFERRAL_PROFIT_BUG_REPORT.md` - このレポート
- `CLAUDE.md` - システム仕様書（更新必要）

---

## ✅ 次のアクション

1. [ ] `CHECK-level2-daily-profit-zero-bug.sql`を実行して全システムの影響範囲を確認
2. [ ] V1関数の修正スクリプトを作成
3. [ ] 誤配布データ削除スクリプトを作成
4. [ ] 管理者に報告書を提出
5. [ ] 修正スクリプトを実行（承認後）
6. [ ] V2システムへの移行を検討

---

**最終更新**: 2025年12月1日
**作成者**: Claude Code AI
**ステータス**: 調査完了、修正待ち
