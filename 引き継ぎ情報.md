# 日利計算v2システム 引き継ぎ情報

## 📌 現在の状態（2025年11月9日時点）

### 完了済み
- ✅ 管理画面UIを新仕様に変更（金額入力方式）
- ✅ stagingブランチにプッシュ済み
- ✅ テスト環境のデータクリーンアップ完了
- ✅ テスト環境で新システム動作確認完了
- ✅ 本番環境移行手順書作成完了

### 次のステップ
- ⏳ 明日、社内で日利を入れて最終確認
- ⏳ 確認OKの場合、本番環境に移行

---

## 🎯 新システムの概要

### 主な変更点

#### 1. 入力方式の変更
**旧システム:**
- 日利率（％）で入力
- マージン率（％）で入力

**新システム:**
- 全体運用利益（$）で金額入力
- マージン率は30%固定（非表示）

#### 2. 計算方式の変更
**旧システム:**
- 各NFTごとに利率を計算
- 日次ベースの計算

**新システム:**
- 全NFTで均等割り
- 累積ベースの計算（G_d, F_d, N_d, ΔN_d）

#### 3. ユーザー表示の変更
**旧システム:**
- 日利率（％）を表示

**新システム:**
- 当日利益（$）のみ表示
- 手数料構造は非表示（ユーザーには見せない）

---

## 🔢 新システムの計算式

### 累積計算
```
P_d = 当日の全体運用利益（管理者が入力する金額）
G_d = G_{d-1} + P_d  （累積利益・手数料前）
F_d = 0.30 × max(G_d, 0)  （累積手数料）
N_d = G_d - F_d  （顧客累積利益）
ΔN_d = N_d - N_{d-1}  （当日確定PNL）
```

### 分配計算（ΔN_d > 0の場合のみ）
```
配当 (60%): ΔN_d × 0.60
アフィリ (30%): ΔN_d × 0.30
ストック (10%): ΔN_d × 0.10
```

### 重要なポイント
- **手数料はプラスの時だけ**: `max(G_d, 0)`を使用
- **分配はΔN_d > 0の時だけ**: マイナスの日は$0配分
- **全NFTで均等割り**: 1NFTあたり = 全体利益 ÷ NFT数

---

## 📊 データベース構造

### 新規テーブル

#### 1. `daily_yield_log_v2`
累積ベースの日利ログ（金額入力方式）

**主要カラム:**
- `total_profit_amount`: 全体運用利益（入力値）
- `total_nft_count`: 全NFT数
- `profit_per_nft`: 1NFTあたり利益
- `cumulative_gross_profit`: G_d（累積利益・手数料前）
- `cumulative_fee`: F_d（累積手数料）
- `cumulative_net_profit`: N_d（顧客累積利益）
- `daily_pnl`: ΔN_d（当日確定PNL）
- `distribution_dividend`: 配当60%
- `distribution_affiliate`: アフィリ30%
- `distribution_stock`: ストック10%

#### 2. `user_monthly_summary`
月次サマリー（将来拡張用）

#### 3. `stock_fund`
ストック資金管理（10%未配分）

#### 4. `daily_yield_calculation_log`
計算ログ（デバッグ用）

### 既存テーブル（変更なし）
- `nft_daily_profit`: NFTごとの日利記録
- `user_referral_profit`: ユーザー紹介報酬
- `affiliate_cycle`: サイクル管理
- `daily_yield_log`: 旧システム（並行稼働）

---

## 🔧 RPC関数

### `process_daily_yield_v2()`

**パラメータ:**
```sql
p_date DATE,  -- 日付
p_total_profit_amount NUMERIC,  -- 全体運用利益（金額）
p_is_test_mode BOOLEAN DEFAULT FALSE  -- テストモード
```

**返り値:**
```sql
RETURNS TABLE(
  status TEXT,  -- SUCCESS / ERROR
  message TEXT,  -- メッセージ
  details JSONB  -- 詳細情報
)
```

**機能:**
1. 全NFT数を取得（ペガサス除く、運用開始日チェック）
2. 1NFTあたり利益を計算
3. 累積計算（G_d, F_d, N_d, ΔN_d）
4. 分配計算（60/30/10）
5. 各ユーザーに配分
6. 整合性チェック

**テストモード:**
- `p_is_test_mode = TRUE`: operation_start_dateチェックをスキップ、配分もスキップ（daily_yield_log_v2のみ記録）
- `p_is_test_mode = FALSE`: 通常モード（本番用）

---

## 📁 関連ファイル

### フロントエンド（stagingブランチ）

#### 管理画面
- `app/admin/yield/page.tsx`: 日利設定画面（完全リニューアル済み）

#### ユーザーダッシュボード
- `app/dashboard/page.tsx`: ダッシュボード（変更なし）
- `components/monthly-cumulative-profit-card.tsx`: 今月の累積利益カード

### バックエンド（Supabase）

#### SQLスクリプト
- `scripts/create-new-yield-system-tables.sql`: v2テーブル作成
- `scripts/fix-rpc-for-test-mode.sql`: RPC関数作成（最新版）
- `scripts/test-daily-yield-v2-simple.sql`: テストスクリプト
- `scripts/cleanup-old-yield-simple.sql`: クリーンアップスクリプト

---

## 🧪 テスト環境で確認済みの内容

### 1. 計算の正確性
設計書のテストケースで100%一致確認済み：

**ケース1（最終プラス）:**
```
P = [+100, -50, +120, -60, +80, -40, +70]
最終: G_d=$220, F_d=$66, N_d=$154
```

**ケース2（最終マイナス）:**
```
P = [+80, -120, +50, -60, -40, -30, -20]
最終: G_d=$80, F_d=$24, N_d=$56
```

### 2. UI/UX
- ✅ 日本語化完了（累積利益、累積手数料、顧客累積利益、当日利益）
- ✅ 金額入力フィールド正常動作
- ✅ プレビュー計算表示
- ✅ 履歴テーブル表示
- ✅ 修正・削除機能

### 3. データクリーンアップ
- ✅ 旧システムデータ削除成功
- ✅ affiliate_cycleリセット成功（364件）
- ✅ user_daily_profit（VIEW）の自動反映確認

---

## 🚨 重要な注意事項

### 1. VIEWテーブルの扱い
`user_daily_profit`はVIEWなので直接DELETE不可。
実テーブルの`nft_daily_profit`を削除すればVIEWも自動反映される。

### 2. ペガサスユーザーの扱い
- `is_pegasus_exchange = TRUE`のユーザーは日利計算から除外
- NFT数カウント時も除外
- 配分時も除外

### 3. 運用開始日チェック
- `operation_start_date`がNULLまたは未来のユーザーは除外
- テストモード時のみこのチェックをスキップ

### 4. 手数料計算のタイミング
- 手数料は累積がプラスの時だけ: `max(G_d, 0)`
- 累積がマイナスの時は手数料0

### 5. 分配のタイミング
- 分配はΔN_d > 0の時だけ
- ΔN_d ≤ 0の時は配当・アフィリ・ストック全て$0

---

## 📝 明日の確認項目

### 社内テスト時のチェックリスト

#### 1. 管理画面で日利設定
- [ ] https://hashpilot-staging.vercel.app/admin/yield にアクセス
- [ ] 日付: 今日の日付
- [ ] 全体運用利益: 実際の金額を入力
- [ ] 「日利を設定」ボタンをクリック

#### 2. 成功メッセージ確認
```
✅ 日利計算完了: YYYY-MM-DD

処理詳細:
• 入力: 全体利益 $XXX.XX
• NFT数: 833個 → 1NFTあたり $X.XXXX

累積計算:
• 累積利益（手数料前）: $XXX.XX
• 累積手数料: $XXX.XX (30%)
• 顧客累積利益: $XXX.XX (70%)
• 当日利益: $XXX.XX

分配:
• 配当 (60%): $XXX.XX
• アフィリ (30%): $XXX.XX
• ストック (10%): $XXX.XX
```

#### 3. 履歴テーブル確認
- [ ] 日付が正しい
- [ ] 運用利益が入力値と一致
- [ ] NFT数が833個
- [ ] 累積値が正しく計算されている
- [ ] 当日利益が表示されている

#### 4. ユーザーダッシュボード確認
- [ ] https://hashpilot-staging.vercel.app/dashboard にアクセス
- [ ] 「今月の累積利益」に金額が表示される
- [ ] グラフにデータが表示される
- [ ] エラーが出ない

#### 5. 計算の検証
- [ ] 累積利益（手数料前）= 前日の累積 + 今日の運用利益
- [ ] 累積手数料 = 累積利益（手数料前）× 30% （プラスの場合のみ）
- [ ] 顧客累積利益 = 累積利益 - 累積手数料
- [ ] 当日利益 = 今日の顧客累積 - 前日の顧客累積

#### 6. 配分の検証
- [ ] 配当60% = 当日利益 × 0.60
- [ ] アフィリ30% = 当日利益 × 0.30
- [ ] ストック10% = 当日利益 × 0.10
- [ ] 合計 = 当日利益（マイナスの場合は全て$0）

---

## 🔄 本番移行の判断基準

### ✅ GO判断（本番移行OK）
以下が全て満たされた場合：
- [ ] 社内テストで日利設定が成功
- [ ] 計算結果が正しい（手計算と一致）
- [ ] ユーザーダッシュボードで正しく表示
- [ ] エラーログに問題なし
- [ ] 関係者の承認取得

### ⚠️ HOLD判断（要調査）
以下のいずれかが発生した場合：
- [ ] 計算結果が手計算と一致しない
- [ ] エラーが発生する
- [ ] ユーザーダッシュボードで表示されない
- [ ] パフォーマンス問題がある

### ❌ NO GO判断（移行延期）
以下のいずれかが発生した場合：
- [ ] 重大なバグが見つかった
- [ ] データ不整合が発生した
- [ ] システムが動作しない

---

## 📞 次回Claude起動時の確認事項

### 状況確認
1. 「社内テストは完了しましたか？」
2. 「テスト結果はOKでしたか？」
3. 「本番環境に移行しますか？」

### 移行実行の場合
1. `本番環境移行手順書.md`を参照
2. ステップ1から順番に実行
3. 各ステップの確認を忘れずに

### 問題が発生した場合
1. エラーログを確認
2. テスト環境と本番環境の違いを確認
3. 必要に応じてロールバック

---

## 🗂️ 重要ファイルの場所

### ドキュメント
- `/mnt/d/HASHPILOT/本番環境移行手順書.md`: 移行手順
- `/mnt/d/HASHPILOT/引き継ぎ情報.md`: このファイル

### SQLスクリプト（本番で実行）
- `/mnt/d/HASHPILOT/scripts/create-new-yield-system-tables.sql`: テーブル作成
- `/mnt/d/HASHPILOT/scripts/fix-rpc-for-test-mode.sql`: RPC関数作成

### SQLスクリプト（テスト用）
- `/mnt/d/HASHPILOT/scripts/test-daily-yield-v2-simple.sql`: テストケース
- `/mnt/d/HASHPILOT/scripts/cleanup-old-yield-simple.sql`: クリーンアップ

### フロントエンド
- `/mnt/d/HASHPILOT/app/admin/yield/page.tsx`: 管理画面（v2システム）

---

## 🌐 環境URL

### テスト環境
- **URL**: https://hashpilot-staging.vercel.app
- **Supabase**: hashpilot-test（Basarasystems）
- **ブランチ**: staging
- **状態**: v2システム稼働中、データクリーンアップ済み

### 本番環境
- **URL**: https://hashpilot.net
- **Supabase**: HASH PILOT（Basarasystems）
- **ブランチ**: main
- **状態**: 旧システム稼働中、v2システム未導入

---

## 📊 現在の統計情報（本番環境）

### NFT数
- 運用中NFT数: 833個（ペガサス除く）
- 総投資額: 計算必要
- アクティブユーザー数: 計算必要

### データベース
- `daily_yield_log`: 旧システムデータ
- `daily_yield_log_v2`: 未作成（本番移行時に作成）
- `affiliate_cycle`: 364ユーザー

---

## ✅ 最終チェックリスト（別PCでの作業前）

### リポジトリの状態
- [x] stagingブランチに全変更をプッシュ済み
- [ ] mainブランチはまだ旧システム
- [x] 本番環境移行手順書作成済み
- [x] 引き継ぎ情報作成済み

### ドキュメント
- [x] SQLスクリプト一式準備完了
- [x] 移行手順書完成
- [x] トラブルシューティング記載済み
- [x] ロールバック手順記載済み

### テスト環境
- [x] v2システム稼働確認済み
- [x] データクリーンアップ完了
- [x] 計算精度確認済み（設計書と100%一致）
- [ ] 社内テスト待ち（明日実施）

---

## 📝 追加作業履歴（2025年11月9日 追加）

### プレビュー機能の実装

管理画面の日利設定で、金額入力時にリアルタイムで以下が表示されるように改善：

**表示内容:**
- 全体運用利益: 入力した金額
- 対象NFT数: 運用中のNFT数（ペガサス除く）
- 配布対象ユーザー数: 運用中NFTを持つユーザー数
- 1NFTあたり利益: 全体利益 ÷ NFT数
- 平均（1ユーザーあたり）: 全体利益 ÷ ユーザー数
- 分配予定: 配当60%、アフィリ30%、ストック10%

**実装ファイル:**
- `app/admin/yield/page.tsx`: プレビュー表示ロジック追加

### 発生したエラーと解決方法

#### エラー1: `users!inner()` 記法での400エラー
**原因:** Supabaseの`users!inner(operation_start_date, is_pegasus_exchange)`記法がエラー

**解決:** 複数の方法を試した結果、最終的に**以前の％ベースシステムで動作していた方法**に戻すことで解決
- `purchases`テーブルから`users!inner()`でユーザー情報を取得
- NFT数を購入額から計算: `Math.floor(amount_usd / 1100)`
- アクティブユーザー数を`Set()`で重複なしカウント

#### エラー2: `daily_yield_log_v2`テーブルへの406エラー
**原因:** RLS（Row Level Security）の権限設定の問題

**解決:** try-catchで処理済み。テーブルにアクセスできない場合は累積利益を$0として扱う

**テスト環境での対処（任意）:**
```sql
-- RLSを無効化（テスト環境のみ）
ALTER TABLE daily_yield_log_v2 DISABLE ROW LEVEL SECURITY;
```

#### エラー3: NFT数が0個と表示される
**原因:** 複雑なクエリでの型の不一致

**解決:** 以前の動作していた実装（`purchases`テーブルからの計算）に戻すことで解決

### テスト環境での動作確認

**確認済み項目:**
- ✅ 統計カード正常表示（アクティブユーザー、運用中NFT数、総投資額、顧客累積利益）
- ✅ プレビュー機能正常動作（金額入力時にリアルタイム表示）
- ✅ NFT数: 689個（テスト環境）
- ✅ アクティブユーザー数: XX名（テスト環境）

**無視してOKなエラー:**
- `origins don't match https://vercel.live`: Vercelのライブプレビュー機能によるもの（無害）
- `406 Not Acceptable` on `daily_yield_log_v2`: try-catchで処理済み（表示に影響なし）

### 本番環境移行時の注意点

1. **daily_yield_log_v2テーブルのRLS設定**
   - 本番環境でも406エラーが出る可能性あり
   - 以下のSQLで管理者アクセスを許可（本番環境移行手順書に記載済み）:
   ```sql
   -- 認証済みユーザー全員が読み取り可能にする
   CREATE POLICY "認証済みユーザーは読み取り可" ON daily_yield_log_v2
   FOR SELECT
   TO authenticated
   USING (true);
   ```

2. **プレビュー表示の確認**
   - 本番環境で初めてアクセスする際は、ブラウザキャッシュをクリア
   - ハードリフレッシュ（Ctrl + Shift + R）を実行

3. **NFT数の計算方法**
   - `purchases`テーブルから計算: `Math.floor(amount_usd / 1100)`
   - 本番環境のNFT数: 833個（確認済み）

---

## 💡 次回作業時のクイックスタート

```bash
# リポジトリの最新状態を取得
cd /mnt/d/HASHPILOT
git fetch origin
git checkout staging
git pull origin staging

# 本番環境移行手順書を開く
# Windows: notepad "本番環境移行手順書.md"
# または任意のテキストエディタで開く
```

---

最終更新: 2025年11月9日（プレビュー機能追加、エラー対応完了）
作成者: Claude (Sonnet 4.5)
次回担当: 別PCでのClaude起動時に自動引き継ぎ
